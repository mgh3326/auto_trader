# Caddyfile for mgh3326.iptime.org
# Automatic HTTPS with Let's Encrypt
# Only exposes necessary services to the internet

{
	# Global options
	email mgh3326@naver.com

	# Use ZeroSSL instead of Let's Encrypt (iptime.org CAA blocks Let's Encrypt)
	acme_ca https://acme.zerossl.com/v2/DV90

	# JSON access logs
	log {
		output file /data/logs/access.log
		format json
	}
}

mgh3326.iptime.org {
	# Security headers (applied to HTTPS responses only)
	header {
		# HTTP Strict Transport Security (HSTS)
		Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"

		# Prevent MIME type sniffing
		X-Content-Type-Options "nosniff"

		# Allow framing from same origin (Grafana needs this for dashboards)
		X-Frame-Options "SAMEORIGIN"

		# XSS Protection
		X-XSS-Protection "1; mode=block"

		# Referrer Policy
		Referrer-Policy "strict-origin-when-cross-origin"
	}

	# Grafana subpath → Grafana service (must come first - more specific)
	handle /grafana* {
		reverse_proxy localhost:3000 {
			# Headers for proper subpath handling
			header_up Host {host}
			header_up X-Real-IP {remote_host}
		}
	}

	# Root path → Auto-trader main application (catch-all)
	handle {
		reverse_proxy localhost:8000 {
			# Headers
			header_up Host {host}
			header_up X-Real-IP {remote_host}
		}
	}

	# Access logs for this site
	log {
		output file /data/logs/mgh3326_access.log {
			roll_size 100mb
			roll_keep 10
			roll_keep_for 720h  # Keep for 30 days
		}
		format json
	}
}
