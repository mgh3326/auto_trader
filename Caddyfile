# Caddyfile for {$DOMAIN_NAME}
# Automatic HTTPS with Let's Encrypt
# Only exposes necessary services to the internet

{
	# Global options
	email {$ACME_EMAIL}

	# JSON access logs
	log {
		output file /data/logs/access.log
		format json
	}
}

{$DOMAIN_NAME} {


	# Security headers
	header {
		# HTTP Strict Transport Security (HSTS)
		Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"

		# Prevent MIME type sniffing
		X-Content-Type-Options "nosniff"

		# Allow framing from same origin (Grafana needs this for dashboards)
		X-Frame-Options "SAMEORIGIN"

		# XSS Protection
		X-XSS-Protection "1; mode=block"

		# Referrer Policy
		Referrer-Policy "strict-origin-when-cross-origin"
	}

	# Grafana subpath → Grafana service (must come first - more specific)
	handle /grafana* {
		reverse_proxy grafana:3000 {
			# Headers for proper subpath handling
			header_up Host {host}
			header_up X-Real-IP {remote_host}
			header_up X-Forwarded-For {remote_host}
			header_up X-Forwarded-Proto {scheme}
		}
	}

	# Root path → Auto-trader main application (catch-all)
	handle {
		reverse_proxy host.docker.internal:8000 {
			# Headers
			header_up Host {host}
			header_up X-Real-IP {remote_host}
			header_up X-Forwarded-For {remote_host}
			header_up X-Forwarded-Proto {scheme}
		}
	}

	# Access logs for this site
	log {
		output file /data/logs/domain_access.log {
			roll_size 100mb
			roll_keep 10
			roll_keep_for 720h  # Keep for 30 days
		}
		format json
	}
}
