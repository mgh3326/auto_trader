# Migration-only compose file
# ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ë³„ë„ë¡œ ì‹¤í–‰í•˜ê¸° ìœ„í•œ íŒŒì¼

services:
  migration:
    image: ghcr.io/${GITHUB_REPOSITORY}:latest
    container_name: auto_trader_migration
    env_file:
      - .env.prod
    network_mode: host
    volumes:
      - ./tmp:/app/tmp
      - ./logs:/app/logs
    command: >
      sh -c "
        echo 'ğŸ” Checking database connection...' &&
        python -c 'import asyncio; import asyncpg; import os; asyncio.run(asyncpg.connect(os.environ[\"DATABASE_URL\"]).connect())' &&
        echo 'âœ… Database connection successful' &&
        echo 'ğŸ“Š Current migration status:' &&
        alembic current &&
        echo 'ğŸ”„ Running migrations...' &&
        alembic upgrade head &&
        echo 'âœ… Migrations completed successfully'
      "
    profiles:
      - migration  # ê¸°ë³¸ ì‹¤í–‰ì—ì„œ ì œì™¸


