services:
  # ë§ˆì´ê·¸ë ˆì´ì…˜ ì „ìš© ì„œë¹„ìŠ¤ (ì„ íƒì  ì‹¤í–‰)
  migration:
    image: ghcr.io/${GITHUB_REPOSITORY}:production
    container_name: auto_trader_migration
    env_file:
      - .env.prod
    network_mode: host
    command: >
      sh -c "
        echo 'ğŸ” Checking database connection...' &&
        python -c 'import asyncio; import asyncpg; import os; dsn = os.environ[\"DATABASE_URL\"].replace(\"postgresql+asyncpg\", \"postgresql\"); asyncio.run(asyncpg.connect(dsn))' &&
        echo 'âœ… Database connection successful' &&
        echo 'ğŸ“Š Current migration status:' &&
        alembic current &&
        echo 'ğŸ”„ Running migrations...' &&
        alembic upgrade head &&
        echo 'âœ… Migrations completed successfully'
      "
    profiles:
      - migration # --profile migrationìœ¼ë¡œë§Œ ì‹¤í–‰

  api:
    image: ghcr.io/${GITHUB_REPOSITORY}:production
    container_name: auto_trader_api_prod
    ports:
      - "${API_PORT:-8000}:8000"
    env_file:
      - .env.prod
    restart: unless-stopped
    network_mode: host # Host ë„¤íŠ¸ì›Œí¬ ì‚¬ìš©ìœ¼ë¡œ localhost DB/Redis ì ‘ê·¼
    healthcheck:
      test: [ "CMD", "python", "-c", "import socket; s=socket.socket(); s.settimeout(2); s.connect(('127.0.0.1',8000)); print('ok')" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '1.5'
        reservations:
          memory: 1G
          cpus: '0.5'

  worker:
    image: ghcr.io/${GITHUB_REPOSITORY}:production
    container_name: auto_trader_worker_prod
    env_file:
      - .env.prod
    restart: unless-stopped
    network_mode: host # Host ë„¤íŠ¸ì›Œí¬ ì‚¬ìš©ìœ¼ë¡œ localhost DB/Redis ì ‘ê·¼
    command: >
      /app/.venv/bin/celery -A app.core.celery_app.celery_app worker --loglevel=INFO -c 1 --max-tasks-per-child=100
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.25'

  mcp:
    image: ghcr.io/${GITHUB_REPOSITORY}:production
    container_name: auto_trader_mcp_prod
    env_file:
      - .env.prod
    environment:
      MCP_TYPE: ${MCP_TYPE:-streamable-http}
      MCP_HOST: ${MCP_HOST:-0.0.0.0}
      MCP_PORT: ${MCP_PORT:-8765}
      MCP_PATH: ${MCP_PATH:-/mcp}
      MCP_AUTH_TOKEN: ${MCP_AUTH_TOKEN:-}
    # network_mode: host ì‚¬ìš© ì‹œ ports ë§¤í•‘ì€ ì ìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
    restart: unless-stopped
    network_mode: host
    command: ["python", "-m", "app.mcp_server.main"]
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.1'

  upbit_websocket:
    image: ghcr.io/${GITHUB_REPOSITORY}:production
    container_name: auto_trader_upbit_ws_prod
    command: [ "python", "websocket_monitor.py", "--mode", "upbit" ]
    env_file:
      - .env.prod
    depends_on:
      - api
    restart: unless-stopped
    network_mode: host # Host ë„¤íŠ¸ì›Œí¬ ì‚¬ìš©ìœ¼ë¡œ localhost DB/Redis ì ‘ê·¼
    healthcheck:
      test: [ "CMD", "pgrep", "-f", "websocket_monitor.py --mode upbit" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.25'
        reservations:
          memory: 128M
          cpus: '0.125'

  kis_websocket:
    image: ghcr.io/${GITHUB_REPOSITORY}:production
    container_name: auto_trader_kis_ws_prod
    command: [ "python", "websocket_monitor.py", "--mode", "kis" ]
    env_file:
      - .env.prod
    depends_on:
      - api
    restart: unless-stopped
    network_mode: host # Host ë„¤íŠ¸ì›Œí¬ ì‚¬ìš©ìœ¼ë¡œ localhost DB/Redis ì ‘ê·¼
    healthcheck:
      test: [ "CMD", "pgrep", "-f", "websocket_monitor.py --mode kis" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.25'
        reservations:
          memory: 128M
          cpus: '0.125'

# ë„¤ì´í‹°ë¸Œ PostgreSQLê³¼ Redis ì‚¬ìš©ìœ¼ë¡œ ë³¼ë¥¨/ë„¤íŠ¸ì›Œí¬ ë¶ˆí•„ìš”
