<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upbit 자동 매매 - Auto Trader</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
            padding: 1.2rem;
            margin-bottom: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .stats-number {
            font-size: 1.8rem;
            font-weight: bold;
            margin: 0;
        }
        .stats-label {
            font-size: 0.9rem;
            opacity: 0.9;
            margin: 0;
        }
        .action-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            background: white;
        }
        .action-card h5 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.8rem;
        }
        .action-card p {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 1rem;
        }
        .btn-action {
            width: 100%;
            padding: 0.75rem;
            font-weight: 600;
        }
        .coin-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            background: white;
        }
        .coin-name {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 0.3rem;
        }
        .coin-symbol {
            font-family: monospace;
            color: #666;
            font-size: 0.9rem;
        }
        .coin-info {
            font-size: 0.85rem;
            margin: 0.3rem 0;
        }
        .profit-positive {
            color: #198754;
            font-weight: 600;
        }
        .profit-negative {
            color: #dc3545;
            font-weight: 600;
        }
        .loading-spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .order-item {
            border-left: 3px solid #0d6efd;
            padding: 0.5rem 0.75rem;
            margin-bottom: 0.5rem;
            background: #f8f9fa;
            border-radius: 4px;
        }
        .order-item.sell {
            border-left-color: #dc3545;
        }
        .alert-custom {
            padding: 0.75rem 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="bi bi-currency-bitcoin"></i> Auto Trader
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/stock-latest/">종목 분석</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/upbit-trading/">Upbit 자동매매</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <!-- 왼쪽: 통계 및 액션 -->
            <div class="col-md-4">
                <h4 class="mb-3">
                    <i class="bi bi-cash-stack"></i> Upbit 자동 매매 대시보드
                </h4>

                <!-- 통계 -->
                <div class="stats-card">
                    <p class="stats-label">KRW 잔고 (사용 가능)</p>
                    <p class="stats-number" id="krw-balance">-</p>
                    <p class="stats-label" style="margin-top: 0.5rem; font-size: 0.75rem;">
                        주문 중: <span id="krw-locked">-</span> | 총: <span id="krw-total">-</span>
                    </p>
                </div>

                <div class="stats-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <p class="stats-label">보유 코인 수</p>
                    <p class="stats-number" id="coin-count">-</p>
                </div>

                <!-- 새로고침 버튼 -->
                <button id="refresh-coins-btn" class="btn btn-outline-primary w-100 mb-3">
                    <i class="bi bi-arrow-clockwise"></i> 새로고침
                </button>

                <!-- 액션 카드 0: 코인별 자동 실행 -->
                <div class="action-card">
                    <h5><i class="bi bi-collection-play"></i> 코인별 자동 실행</h5>
                    <p>보유 중인 각 코인에 대해 순서대로 <strong>분석 → 분할 매수 → 분할 매도</strong> 요청을 전송합니다. 요청은 코인 단위로 순차 처리되어 API 쿼터를 절약합니다.</p>

                    <div id="per-coin-automation-progress" style="display: none; margin-bottom: 1rem;">
                        <div class="progress" style="height: 25px;">
                            <div id="per-coin-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated bg-info"
                                 role="progressbar" style="width: 0%">
                                0%
                            </div>
                        </div>
                        <div id="per-coin-automation-status" class="small text-muted mt-2">준비 중...</div>
                        <div id="per-coin-automation-log" class="small mt-2 text-break" style="max-height: 160px; overflow-y: auto;"></div>
                    </div>

                    <button id="per-coin-automation-btn" class="btn btn-outline-primary btn-action">
                        <i class="bi bi-collection-play"></i> 코인별 분석→매수→매도
                    </button>
                </div>

                <!-- 액션 카드 1: AI 분석 -->
                <div class="action-card">
                    <h5><i class="bi bi-robot"></i> AI 분석 실행</h5>
                    <p>보유 코인에 대한 AI 투자 분석을 실행합니다.</p>

                    <!-- 프로그레스바 -->
                    <div id="analysis-progress" style="display: none; margin-bottom: 1rem;">
                        <div class="progress" style="height: 25px;">
                            <div id="analysis-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated"
                                 role="progressbar" style="width: 0%">
                                0%
                            </div>
                        </div>
                        <div id="analysis-status" style="font-size: 0.85rem; margin-top: 0.5rem; color: #666;">
                            분석 준비 중...
                        </div>
                    </div>

                    <button id="analyze-btn" class="btn btn-primary btn-action" onclick="analyzeCoins()">
                        <i class="bi bi-cpu"></i> 분석 시작
                    </button>
                </div>

                <!-- 액션 카드 2: 자동 매수 -->
                <div class="action-card">
                    <h5><i class="bi bi-cart-plus"></i> 자동 매수 주문</h5>
                    <p>AI 분석 결과를 기반으로 분할 매수 주문을 실행합니다.</p>

                    <!-- 프로그레스바 -->
                    <div id="buy-progress" style="display: none; margin-bottom: 1rem;">
                        <div class="progress" style="height: 25px;">
                            <div id="buy-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated bg-success"
                                 role="progressbar" style="width: 0%">
                                0%
                            </div>
                        </div>
                        <div id="buy-status" style="font-size: 0.85rem; margin-top: 0.5rem; color: #666;">
                            매수 주문 준비 중...
                        </div>
                    </div>

                    <button id="buy-btn" class="btn btn-success btn-action" onclick="executeBuyOrders()">
                        <i class="bi bi-arrow-down-circle"></i> 매수 주문
                    </button>
                </div>

                <!-- 액션 카드 3: 자동 매도 -->
                <div class="action-card">
                    <h5><i class="bi bi-cart-dash"></i> 자동 매도 주문</h5>
                    <p>AI 분석 결과를 기반으로 분할 매도 주문을 실행합니다.</p>

                    <!-- 프로그레스바 -->
                    <div id="sell-progress" style="display: none; margin-bottom: 1rem;">
                        <div class="progress" style="height: 25px;">
                            <div id="sell-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated bg-danger"
                                 role="progressbar" style="width: 0%">
                                0%
                            </div>
                        </div>
                        <div id="sell-status" style="font-size: 0.85rem; margin-top: 0.5rem; color: #666;">
                            매도 주문 준비 중...
                        </div>
                    </div>

                    <button id="sell-btn" class="btn btn-danger btn-action" onclick="executeSellOrders()">
                        <i class="bi bi-arrow-up-circle"></i> 매도 주문
                    </button>
                </div>

                <!-- 액션 카드 4: 미체결 주문 취소 -->
                <div class="action-card">
                    <h5><i class="bi bi-x-circle"></i> 미체결 주문 관리</h5>
                    <p>현재 체결 대기 중인 모든 주문을 조회하거나 취소합니다.</p>
                    <button class="btn btn-outline-secondary btn-action mb-2" onclick="loadOpenOrders()">
                        <i class="bi bi-list-check"></i> 미체결 조회
                    </button>
                    <button class="btn btn-outline-danger btn-action" onclick="cancelAllOrders()">
                        <i class="bi bi-trash"></i> 전체 취소
                    </button>
                </div>
            </div>

            <!-- 오른쪽: 보유 코인 목록 -->
            <div class="col-md-8">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5><i class="bi bi-wallet2"></i> 보유 코인 목록</h5>
                    <span class="badge bg-primary" id="tradable-count">0개</span>
                </div>

                <!-- 알림 영역 -->
                <div id="alert-area"></div>

                <!-- 보유 코인 목록 -->
                <div id="coins-list">
                    <div class="text-center text-muted py-5">
                        <i class="bi bi-wallet2" style="font-size: 3rem;"></i>
                        <p class="mt-3">새로고침 버튼을 눌러 보유 코인을 불러오세요.</p>
                    </div>
                </div>

                <!-- 미체결 주문 영역 -->
                <div id="open-orders-section" style="display: none;">
                    <hr class="my-4">
                    <h5 class="mb-3"><i class="bi bi-hourglass-split"></i> 미체결 주문</h5>
                    <div id="open-orders-list"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 코인 분석 상세 모달 -->
    <div class="modal fade" id="coinAnalysisModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">종목 분석 상세</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center text-muted py-4">
                        <div class="spinner-border" role="status"></div>
                    </div>
                </div>
                <div class="modal-footer d-flex justify-content-between align-items-center">
                    <a href="#" class="btn btn-outline-primary" id="coinAnalysisLink" target="_blank" rel="noopener">
                        <i class="bi bi-box-arrow-up-right"></i> 종목 분석 페이지 이동
                    </a>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // localStorage 키
        const STORAGE_KEYS = {
            ANALYSIS: 'upbit_analysis_task_id',
            BUY: 'upbit_buy_task_id',
            SELL: 'upbit_sell_task_id',
            COIN_AUTOMATION: 'upbit_coin_automation_task_id'
        };
        let cachedTradableCoins = [];
        let perCoinAutomationRunning = false;
        let coinAutomationTaskId = null;
        let coinAutomationInterval = null;

        // 페이지 로드 시 보유 코인 조회 및 진행 중인 작업 복원
        document.addEventListener('DOMContentLoaded', async function() {
            const refreshButton = document.getElementById('refresh-coins-btn');
            if (refreshButton) {
                refreshButton.addEventListener('click', () => {
                    loadMyCoins().catch((error) => console.error('loadMyCoins failed', error));
                });
            }

            const automationButton = document.getElementById('per-coin-automation-btn');
            if (automationButton) {
                automationButton.addEventListener('click', () => {
                    runPerCoinAutomation().catch((error) => console.error('runPerCoinAutomation failed', error));
                });
            }

            try {
                await loadMyCoins();
            } catch (error) {
                console.error('loadMyCoins failed', error);
            }

            try {
                await restoreActiveTasks();
            } catch (error) {
                console.error('restoreActiveTasks failed', error);
            }
        });

        // 진행 중인 작업 복원
        async function restoreActiveTasks() {
            // 분석 작업 복원
            const storedAnalysisTaskId = localStorage.getItem(STORAGE_KEYS.ANALYSIS);
            if (storedAnalysisTaskId) {
                analysisTaskId = storedAnalysisTaskId;
                const response = await fetch(`/upbit-trading/api/analyze-task/${analysisTaskId}`);
                const data = await response.json();

                if (data.state === 'PROGRESS' || data.state === 'PENDING') {
                    document.getElementById('analysis-progress').style.display = 'block';
                    document.getElementById('analyze-btn').disabled = true;
                    analysisCheckInterval = setInterval(checkAnalysisProgress, 1000);
                } else if (data.state === 'SUCCESS' || data.state === 'FAILURE') {
                    localStorage.removeItem(STORAGE_KEYS.ANALYSIS);
                }
            }

            // 매수 작업 복원
            const storedBuyTaskId = localStorage.getItem(STORAGE_KEYS.BUY);
            if (storedBuyTaskId) {
                buyTaskId = storedBuyTaskId;
                const response = await fetch(`/upbit-trading/api/analyze-task/${buyTaskId}`);
                const data = await response.json();

                if (data.state === 'PROGRESS' || data.state === 'PENDING') {
                    document.getElementById('buy-progress').style.display = 'block';
                    document.getElementById('buy-btn').disabled = true;
                    buyCheckInterval = setInterval(checkBuyProgress, 1000);
                } else if (data.state === 'SUCCESS' || data.state === 'FAILURE') {
                    localStorage.removeItem(STORAGE_KEYS.BUY);
                }
            }

            // 매도 작업 복원
            const storedSellTaskId = localStorage.getItem(STORAGE_KEYS.SELL);
            if (storedSellTaskId) {
                sellTaskId = storedSellTaskId;
                const response = await fetch(`/upbit-trading/api/analyze-task/${sellTaskId}`);
                const data = await response.json();

                if (data.state === 'PROGRESS' || data.state === 'PENDING') {
                    document.getElementById('sell-progress').style.display = 'block';
                    document.getElementById('sell-btn').disabled = true;
                    sellCheckInterval = setInterval(checkSellProgress, 1000);
                } else if (data.state === 'SUCCESS' || data.state === 'FAILURE') {
                    localStorage.removeItem(STORAGE_KEYS.SELL);
                }
            }

            // 코인별 자동 실행 복원
            const storedCoinAutomationTaskId = localStorage.getItem(STORAGE_KEYS.COIN_AUTOMATION);
            if (storedCoinAutomationTaskId) {
                coinAutomationTaskId = storedCoinAutomationTaskId;
                perCoinAutomationRunning = true;

                const progressWrapper = document.getElementById('per-coin-automation-progress');
                const statusEl = document.getElementById('per-coin-automation-status');
                const button = document.getElementById('per-coin-automation-btn');

                if (progressWrapper) {
                    progressWrapper.style.display = 'block';
                }
                if (statusEl) {
                    statusEl.textContent = '작업 상태를 확인하는 중입니다...';
                }
                if (button) {
                    button.disabled = true;
                    button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 실행 중...';
                }

                if (coinAutomationInterval) {
                    clearInterval(coinAutomationInterval);
                }
                await checkCoinAutomationProgress();
                coinAutomationInterval = setInterval(checkCoinAutomationProgress, 2000);
            }
        }

        // 보유 코인 조회
        async function loadMyCoins() {
            try {
                const response = await fetch('/upbit-trading/api/my-coins');
                const data = await response.json();

                if (data.success) {
                    // 통계 업데이트
                    document.getElementById('krw-balance').textContent =
                        new Intl.NumberFormat('ko-KR', { maximumFractionDigits: 0 }).format(data.krw_balance) + '원';
                    document.getElementById('krw-locked').textContent =
                        new Intl.NumberFormat('ko-KR', { maximumFractionDigits: 0 }).format(data.krw_locked) + '원';
                    document.getElementById('krw-total').textContent =
                        new Intl.NumberFormat('ko-KR', { maximumFractionDigits: 0 }).format(data.krw_total) + '원';
                    document.getElementById('coin-count').textContent = data.tradable_coins_count + '개';
                    document.getElementById('tradable-count').textContent = data.tradable_coins_count + '개';

                    cachedTradableCoins = data.coins || [];

                    // 코인 목록 렌더링
                    const coinsList = document.getElementById('coins-list');
                    if (data.coins.length === 0) {
                        coinsList.innerHTML = `
                            <div class="text-center text-muted py-5">
                                <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                                <p class="mt-3">거래 가능한 코인이 없습니다.</p>
                            </div>
                        `;
                    } else {
                        coinsList.innerHTML = data.coins.map(coin => {
                            const profitRate = Number(coin.profit_rate || 0);
                            const profitRatePercent = (profitRate * 100).toFixed(2);
                            const profitClass = profitRate >= 0 ? 'profit-positive' : 'profit-negative';
                            const profitSign = profitRate >= 0 ? '+' : '';
                            const lastAnalysisText = formatLastAnalysisTime(coin.last_analysis_at);
                            const balanceDisplay = coin.balance_display
                                ?? formatCoinAmount(coin.balance_raw ?? coin.balance);
                            const lockedDisplay = coin.locked_display
                                ?? formatCoinAmount(coin.locked_raw ?? coin.locked);
                            const totalDisplay = formatCoinAmount(
                                Number(coin.balance ?? 0) + Number(coin.locked ?? 0)
                            );
                            const analysisMeta = coin.last_analysis_decision
                                ? `<div class="d-flex align-items-center gap-2 flex-wrap mt-1">
                                        ${getDecisionBadge(coin.last_analysis_decision)}
                                        <span class="small text-muted">신뢰도 ${formatConfidence(coin.analysis_confidence)}</span>
                                   </div>`
                                : `<div class="small text-muted mt-1">분석 정보가 없습니다.</div>`;
                            const analysisDetailButton = coin.analysis_id
                                ? `<button
                                        class="btn btn-outline-primary btn-sm coin-analysis-btn"
                                        data-analysis-id="${coin.analysis_id}"
                                        data-symbol="${escapeHtml(coin.market)}"
                                        data-name="${escapeHtml(coin.korean_name)}">
                                        <i class="bi bi-search"></i> 종목 분석 상세
                                   </button>`
                                : `<button class="btn btn-outline-secondary btn-sm" disabled>
                                        <i class="bi bi-search"></i> 분석 기록 없음
                                   </button>`;
                            const analyzeButton = `
                                <button
                                    class="btn btn-outline-info btn-sm coin-analyze-btn"
                                    data-currency="${escapeHtml(coin.currency)}"
                                    data-korean-name="${escapeHtml(coin.korean_name)}"
                                >
                                    <i class="bi bi-robot"></i> 분석 실행
                                </button>
                            `;
                            const buyButton = `
                                <button
                                    class="btn btn-outline-success btn-sm coin-buy-btn"
                                    data-currency="${escapeHtml(coin.currency)}"
                                >
                                    <i class="bi bi-cart-plus"></i> 분할 매수
                                </button>
                            `;
                            const sellButton = `
                                <button
                                    class="btn btn-outline-danger btn-sm coin-sell-btn"
                                    data-currency="${escapeHtml(coin.currency)}"
                                >
                                    <i class="bi bi-cart-dash"></i> 분할 매도
                                </button>
                            `;
                            const actionButtons = `
                                <div class="d-flex flex-wrap gap-2 justify-content-lg-end">
                                    ${analysisDetailButton}
                                    ${analyzeButton}
                                    ${buyButton}
                                    ${sellButton}
                                </div>
                            `;

                            return `
                                <div class="coin-card">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <div class="coin-name">${escapeHtml(coin.korean_name)}</div>
                                            <div class="coin-symbol">${escapeHtml(coin.currency)} (${escapeHtml(coin.market)})</div>
                                        </div>
                                        <div class="text-end">
                                            <div class="${profitClass}" style="font-size: 1.2rem;">
                                                ${profitSign}${profitRatePercent}%
                                            </div>
                                            <div class="coin-info ${profitClass}">
                        ${profitSign}${new Intl.NumberFormat('ko-KR', { maximumFractionDigits: 0 }).format(Math.trunc(coin.profit_loss))}원
                                            </div>
                                        </div>
                                    </div>
                                    <hr class="my-2">
                                    <div class="row coin-info">
                                        <div class="col-6">매도 가능 수량: ${balanceDisplay}</div>
                                        <div class="col-6 text-end">주문 중: ${lockedDisplay}</div>
                                    </div>
                                    <div class="row coin-info">
                                        <div class="col-6">총 수량: ${totalDisplay}</div>
                                        <div class="col-6 text-end">현재가: ${new Intl.NumberFormat('ko-KR', { maximumFractionDigits: 0 }).format(Math.trunc(coin.current_price))}원</div>
                                    </div>
                                    <div class="row coin-info">
                                        <div class="col-6">평균 단가: ${new Intl.NumberFormat('ko-KR', { maximumFractionDigits: 0 }).format(Math.trunc(coin.avg_buy_price))}원</div>
                                        <div class="col-6 text-end">평가금액: ${new Intl.NumberFormat('ko-KR', { maximumFractionDigits: 0 }).format(Math.trunc(coin.evaluation))}원</div>
                                    </div>
                                    <div class="coin-info mt-3 d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-2">
                                        <div>
                                            <div class="small text-muted">${lastAnalysisText}</div>
                                            ${analysisMeta}
                                        </div>
                                        ${actionButtons}
                                    </div>
                                </div>
                            `;
                        }).join('');
                        attachCoinActionHandlers();
                    }
                } else {
                    cachedTradableCoins = [];
                    showAlert('보유 코인 조회 실패: ' + data.error, 'danger');
                }
            } catch (error) {
                cachedTradableCoins = [];
                showAlert('보유 코인 조회 중 오류 발생: ' + error.message, 'danger');
            }
        }
        // AI 분석 실행
        let analysisTaskId = null;
        let analysisCheckInterval = null;

        async function analyzeCoins() {
            if (!confirm('보유 코인에 대한 AI 분석을 시작하시겠습니까?')) {
                return;
            }

            try {
                // 버튼 비활성화
                const analyzeBtn = document.getElementById('analyze-btn');
                analyzeBtn.disabled = true;
                analyzeBtn.innerHTML = '<span class="loading-spinner"></span> 시작 중...';

                const response = await fetch('/upbit-trading/api/analyze-coins', {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success && data.task_id) {
                    // 프로그레스바 표시
                    document.getElementById('analysis-progress').style.display = 'block';

                    // Task ID 저장 (메모리 및 localStorage)
                    analysisTaskId = data.task_id;
                    localStorage.setItem(STORAGE_KEYS.ANALYSIS, data.task_id);

                    // 주기적으로 상태 확인 (1초마다)
                    analysisCheckInterval = setInterval(checkAnalysisProgress, 1000);

                    showAlert('✅ AI 분석이 시작되었습니다.', 'success');
                } else {
                    showAlert('❌ 분석 실행 실패', 'danger');
                    resetAnalysisUI();
                }
            } catch (error) {
                showAlert('분석 실행 중 오류 발생: ' + error.message, 'danger');
                resetAnalysisUI();
            }
        }

        // 분석 진행 상황 확인
        async function checkAnalysisProgress() {
            if (!analysisTaskId) return;

            try {
                const response = await fetch(`/upbit-trading/api/analyze-task/${analysisTaskId}`);
                const data = await response.json();

                if (data.state === 'PROGRESS' && data.progress) {
                    // 진행 중
                    const progress = data.progress;
                    const percentage = progress.percentage || 0;

                    // 프로그레스바 업데이트
                    const progressBar = document.getElementById('analysis-progress-bar');
                    progressBar.style.width = percentage + '%';
                    progressBar.textContent = percentage + '%';

                    // 상태 텍스트 업데이트
                    const statusText = progress.status || '분석 중...';
                    document.getElementById('analysis-status').textContent = statusText;

                } else if (data.state === 'SUCCESS' && data.ready) {
                    // 완료
                    clearInterval(analysisCheckInterval);

                    // 프로그레스바 100%
                    const progressBar = document.getElementById('analysis-progress-bar');
                    progressBar.style.width = '100%';
                    progressBar.textContent = '100%';
                    progressBar.classList.remove('progress-bar-animated');
                    progressBar.classList.add('bg-success');

                    const result = data.result || {};
                    const message = result.message || '분석 완료';
                    document.getElementById('analysis-status').textContent = '✅ ' + message;

                    showAlert('✅ ' + message, 'success');

                    // 3초 후 UI 리셋
                    setTimeout(resetAnalysisUI, 3000);

                } else if (data.state === 'FAILURE') {
                    // 실패
                    clearInterval(analysisCheckInterval);

                    const progressBar = document.getElementById('analysis-progress-bar');
                    progressBar.classList.remove('progress-bar-animated');
                    progressBar.classList.add('bg-danger');

                    const error = data.error || '알 수 없는 오류';
                    document.getElementById('analysis-status').textContent = '❌ 분석 실패: ' + error;

                    showAlert('❌ 분석 실패: ' + error, 'danger');

                    setTimeout(resetAnalysisUI, 5000);
                }
            } catch (error) {
                console.error('진행 상황 확인 실패:', error);
            }
        }

        // 분석 UI 리셋
        function resetAnalysisUI() {
            // 인터벌 정리
            if (analysisCheckInterval) {
                clearInterval(analysisCheckInterval);
                analysisCheckInterval = null;
            }

            // Task ID 초기화 (메모리 및 localStorage)
            analysisTaskId = null;
            localStorage.removeItem(STORAGE_KEYS.ANALYSIS);

            // 프로그레스바 숨기기
            document.getElementById('analysis-progress').style.display = 'none';

            // 프로그레스바 리셋
            const progressBar = document.getElementById('analysis-progress-bar');
            progressBar.style.width = '0%';
            progressBar.textContent = '0%';
            progressBar.classList.remove('bg-success', 'bg-danger');
            progressBar.classList.add('progress-bar-animated');

            // 상태 텍스트 리셋
            document.getElementById('analysis-status').textContent = '분석 준비 중...';

            // 버튼 활성화
            const analyzeBtn = document.getElementById('analyze-btn');
            analyzeBtn.disabled = false;
            analyzeBtn.innerHTML = '<i class="bi bi-cpu"></i> 분석 시작';
        }

        // 자동 매수 주문
        let buyTaskId = null;
        let buyCheckInterval = null;

        async function executeBuyOrders() {
            if (!confirm('보유 코인에 대한 자동 매수 주문을 실행하시겠습니까?\n(기존 매수 주문은 취소됩니다)')) {
                return;
            }

            try {
                // 버튼 비활성화 및 프로그레스바 표시
                const buyBtn = document.getElementById('buy-btn');
                const buyProgress = document.getElementById('buy-progress');
                const buyProgressBar = document.getElementById('buy-progress-bar');
                const buyStatus = document.getElementById('buy-status');

                buyBtn.disabled = true;
                buyProgress.style.display = 'block';
                buyProgressBar.style.width = '0%';
                buyProgressBar.textContent = '0%';
                buyStatus.textContent = '매수 주문 시작 중...';

                const response = await fetch('/upbit-trading/api/buy-orders', {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success && data.task_id) {
                    buyTaskId = data.task_id;
                    localStorage.setItem(STORAGE_KEYS.BUY, data.task_id);
                    showAlert('✅ ' + data.message, 'success');

                    // 프로그레스 체크 시작
                    buyCheckInterval = setInterval(checkBuyProgress, 1000);
                } else {
                    showAlert('❌ 매수 주문 시작 실패', 'danger');
                    buyBtn.disabled = false;
                    buyProgress.style.display = 'none';
                }
            } catch (error) {
                showAlert('매수 주문 중 오류 발생: ' + error.message, 'danger');
                document.getElementById('buy-btn').disabled = false;
                document.getElementById('buy-progress').style.display = 'none';
            }
        }

        async function checkBuyProgress() {
            if (!buyTaskId) return;

            try {
                const response = await fetch(`/upbit-trading/api/analyze-task/${buyTaskId}`);
                const data = await response.json();

                const buyProgressBar = document.getElementById('buy-progress-bar');
                const buyStatus = document.getElementById('buy-status');

                if (data.state === 'PROGRESS' && data.progress) {
                    const percentage = data.progress.percentage || 0;
                    buyProgressBar.style.width = percentage + '%';
                    buyProgressBar.textContent = percentage + '%';
                    buyStatus.textContent = data.progress.status || '매수 주문 진행 중...';
                } else if (data.state === 'SUCCESS') {
                    clearInterval(buyCheckInterval);
                    buyTaskId = null;
                    localStorage.removeItem(STORAGE_KEYS.BUY);

                    buyProgressBar.style.width = '100%';
                    buyProgressBar.textContent = '100%';
                    buyStatus.textContent = '완료!';

                    if (data.result) {
                        const message = data.result.message || `${data.result.success_count}/${data.result.total_count}개 코인 매수 주문 완료`;
                        showAlert('✅ ' + message, 'success');

                        // 결과 상세 표시
                        if (data.result.results && data.result.results.length > 0) {
                            const resultHtml = data.result.results.map(r => {
                                const icon = r.success ? '✅' : '❌';
                                const msg = r.success ? r.message : r.error;
                                return `<div>${icon} ${r.currency}: ${msg}</div>`;
                            }).join('');
                            showAlert(resultHtml, 'info');
                        }
                    }

                    // 버튼 다시 활성화 및 프로그레스바 숨김
                    setTimeout(() => {
                        document.getElementById('buy-btn').disabled = false;
                        document.getElementById('buy-progress').style.display = 'none';
                        loadMyCoins();
                    }, 2000);
                } else if (data.state === 'FAILURE') {
                    clearInterval(buyCheckInterval);
                    buyTaskId = null;
                    localStorage.removeItem(STORAGE_KEYS.BUY);

                    showAlert('❌ 매수 주문 실패: ' + (data.result?.error || '알 수 없는 오류'), 'danger');
                    document.getElementById('buy-btn').disabled = false;
                    document.getElementById('buy-progress').style.display = 'none';
                }
            } catch (error) {
                console.error('Progress check error:', error);
            }
        }

        // 자동 매도 주문
        let sellTaskId = null;
        let sellCheckInterval = null;

        async function executeSellOrders() {
            if (!confirm('보유 코인에 대한 자동 매도 주문을 실행하시겠습니까?\n(기존 매도 주문은 취소됩니다)')) {
                return;
            }

            try {
                // 버튼 비활성화 및 프로그레스바 표시
                const sellBtn = document.getElementById('sell-btn');
                const sellProgress = document.getElementById('sell-progress');
                const sellProgressBar = document.getElementById('sell-progress-bar');
                const sellStatus = document.getElementById('sell-status');

                sellBtn.disabled = true;
                sellProgress.style.display = 'block';
                sellProgressBar.style.width = '0%';
                sellProgressBar.textContent = '0%';
                sellStatus.textContent = '매도 주문 시작 중...';

                const response = await fetch('/upbit-trading/api/sell-orders', {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success && data.task_id) {
                    sellTaskId = data.task_id;
                    localStorage.setItem(STORAGE_KEYS.SELL, data.task_id);
                    showAlert('✅ ' + data.message, 'success');

                    // 프로그레스 체크 시작
                    sellCheckInterval = setInterval(checkSellProgress, 1000);
                } else {
                    showAlert('❌ 매도 주문 시작 실패', 'danger');
                    sellBtn.disabled = false;
                    sellProgress.style.display = 'none';
                }
            } catch (error) {
                showAlert('매도 주문 중 오류 발생: ' + error.message, 'danger');
                document.getElementById('sell-btn').disabled = false;
                document.getElementById('sell-progress').style.display = 'none';
            }
        }

        async function checkSellProgress() {
            if (!sellTaskId) return;

            try {
                const response = await fetch(`/upbit-trading/api/analyze-task/${sellTaskId}`);
                const data = await response.json();

                const sellProgressBar = document.getElementById('sell-progress-bar');
                const sellStatus = document.getElementById('sell-status');

                if (data.state === 'PROGRESS' && data.progress) {
                    const percentage = data.progress.percentage || 0;
                    sellProgressBar.style.width = percentage + '%';
                    sellProgressBar.textContent = percentage + '%';
                    sellStatus.textContent = data.progress.status || '매도 주문 진행 중...';
                } else if (data.state === 'SUCCESS') {
                    clearInterval(sellCheckInterval);
                    sellTaskId = null;
                    localStorage.removeItem(STORAGE_KEYS.SELL);

                    sellProgressBar.style.width = '100%';
                    sellProgressBar.textContent = '100%';
                    sellStatus.textContent = '완료!';

                    if (data.result) {
                        const message = data.result.message || `${data.result.success_count}/${data.result.total_count}개 코인 매도 주문 완료`;
                        showAlert('✅ ' + message, 'success');

                        // 결과 상세 표시
                        if (data.result.results && data.result.results.length > 0) {
                            const resultHtml = data.result.results.map(r => {
                                const icon = r.success ? '✅' : '❌';
                                const msg = r.success ? r.message : r.error;
                                return `<div>${icon} ${r.currency}: ${msg}</div>`;
                            }).join('');
                            showAlert(resultHtml, 'info');
                        }
                    }

                    // 버튼 다시 활성화 및 프로그레스바 숨김
                    setTimeout(() => {
                        document.getElementById('sell-btn').disabled = false;
                        document.getElementById('sell-progress').style.display = 'none';
                        loadMyCoins();
                    }, 2000);
                } else if (data.state === 'FAILURE') {
                    clearInterval(sellCheckInterval);
                    sellTaskId = null;
                    localStorage.removeItem(STORAGE_KEYS.SELL);

                    showAlert('❌ 매도 주문 실패: ' + (data.result?.error || '알 수 없는 오류'), 'danger');
                    document.getElementById('sell-btn').disabled = false;
                    document.getElementById('sell-progress').style.display = 'none';
                }
            } catch (error) {
                console.error('Progress check error:', error);
            }
        }

        // 미체결 주문 조회
        async function loadOpenOrders() {
            try {
                showAlert('미체결 주문을 조회 중입니다...', 'info');

                const response = await fetch('/upbit-trading/api/open-orders');
                const data = await response.json();

                if (data.success) {
                    const section = document.getElementById('open-orders-section');
                    const list = document.getElementById('open-orders-list');

                    if (data.orders.length === 0) {
                        showAlert('미체결 주문이 없습니다.', 'info');
                        section.style.display = 'none';
                    } else {
                        showAlert(`미체결 주문 ${data.total_count}개를 찾았습니다.`, 'success');
                        section.style.display = 'block';

                        list.innerHTML = data.orders.map(order => {
                            const isBuy = order.side === 'bid';
                            const sideText = isBuy ? '매수' : '매도';
                            const sideClass = isBuy ? '' : 'sell';
                            const sideIcon = isBuy ? 'arrow-down-circle' : 'arrow-up-circle';

                            return `
                                <div class="order-item ${sideClass}">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <i class="bi bi-${sideIcon}"></i>
                                            <strong>${order.korean_name} (${order.currency})</strong> - ${sideText}
                                        </div>
                                        <div class="text-end">
                                            <span class="badge bg-secondary">${order.state}</span>
                                        </div>
                                    </div>
                                    <div class="mt-1" style="font-size: 0.85rem; color: #666;">
                                        가격: ${new Intl.NumberFormat('ko-KR', { maximumFractionDigits: 0 }).format(order.price)}원 |
                                        수량: ${order.volume} |
                                        미체결: ${order.remaining_volume}
                                    </div>
                                </div>
                            `;
                        }).join('');
                    }
                } else {
                    showAlert('미체결 주문 조회 실패: ' + data.error, 'danger');
                }
            } catch (error) {
                showAlert('미체결 주문 조회 중 오류 발생: ' + error.message, 'danger');
            }
        }

        // 모든 미체결 주문 취소
        async function cancelAllOrders() {
            if (!confirm('모든 미체결 주문을 취소하시겠습니까?')) {
                return;
            }

            try {
                showAlert('미체결 주문을 취소 중입니다... <span class="loading-spinner"></span>', 'info');

                const response = await fetch('/upbit-trading/api/cancel-orders', {
                    method: 'DELETE'
                });
                const data = await response.json();

                if (data.success) {
                    const totalCancelled = data.results.reduce((sum, r) => sum + (r.cancelled_count || 0), 0);
                    showAlert(`✅ 총 ${totalCancelled}개 주문이 취소되었습니다.`, 'success');

                    // 미체결 주문 섹션 숨기기
                    document.getElementById('open-orders-section').style.display = 'none';

                    // 보유 코인 새로고침
                    setTimeout(loadMyCoins, 2000);
                } else {
                    showAlert('❌ 주문 취소 실패', 'danger');
                }
            } catch (error) {
                showAlert('주문 취소 중 오류 발생: ' + error.message, 'danger');
            }
        }

        function attachCoinActionHandlers() {
            document.querySelectorAll('.coin-analysis-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const analysisId = Number(button.dataset.analysisId);
                    const symbol = button.dataset.symbol;
                    const name = button.dataset.name;

                    if (!analysisId) {
                        return;
                    }

                    openCoinAnalysisDetail(analysisId, symbol, name);
                });
            });

            document.querySelectorAll('.coin-analyze-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const currency = button.dataset.currency;
                    const koreanName = button.dataset.koreanName;
                    triggerCoinAnalysis(currency, koreanName, button);
                });
            });

            document.querySelectorAll('.coin-buy-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const currency = button.dataset.currency;
                    triggerCoinBuy(currency, button);
                });
            });

            document.querySelectorAll('.coin-sell-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const currency = button.dataset.currency;
                    triggerCoinSell(currency, button);
                });
            });
        }

        async function triggerCoinAnalysis(currency, koreanName, button) {
            if (!currency) return;
            const coinCode = currency.toUpperCase();
            const displayName = koreanName || coinCode;

            if (!confirm(`${displayName} (${coinCode})에 대한 AI 분석을 실행할까요?`)) {
                return;
            }

            const originalContent = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 요청 중...';

            try {
                const response = await fetch(`/upbit-trading/api/coin/${encodeURIComponent(coinCode)}/analysis`, {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success) {
                    showAlert(data.message || `${displayName} 분석이 시작되었습니다.`, 'success');
                } else {
                    const errorMessage = data.error || data.message || `${displayName} 분석 요청에 실패했습니다.`;
                    showAlert(`❌ ${errorMessage}`, 'danger');
                }
            } catch (error) {
                showAlert(`❌ ${displayName} 분석 요청 중 오류 발생: ${error.message}`, 'danger');
            } finally {
                button.disabled = false;
                button.innerHTML = originalContent;
            }
        }

        async function triggerCoinBuy(currency, button) {
            if (!currency) return;
            const coinCode = currency.toUpperCase();

            if (!confirm(`${coinCode}에 대한 분할 매수 주문을 실행할까요? 기존 매수 주문은 취소됩니다.`)) {
                return;
            }

            const originalContent = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 요청 중...';

            try {
                const response = await fetch(`/upbit-trading/api/coin/${encodeURIComponent(coinCode)}/buy-orders`, {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success) {
                    showAlert(data.message || `${coinCode} 분할 매수 주문이 시작되었습니다.`, 'success');
                    setTimeout(loadMyCoins, 2000);
                } else {
                    const errorMessage = data.error || data.message || `${coinCode} 매수 주문 요청에 실패했습니다.`;
                    showAlert(`❌ ${errorMessage}`, 'danger');
                }
            } catch (error) {
                showAlert(`❌ ${coinCode} 매수 주문 요청 중 오류 발생: ${error.message}`, 'danger');
            } finally {
                button.disabled = false;
                button.innerHTML = originalContent;
            }
        }

        async function triggerCoinSell(currency, button) {
            if (!currency) return;
            const coinCode = currency.toUpperCase();

            if (!confirm(`${coinCode}에 대한 분할 매도 주문을 실행할까요? 기존 매도 주문은 취소됩니다.`)) {
                return;
            }

            const originalContent = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 요청 중...';

            try {
                const response = await fetch(`/upbit-trading/api/coin/${encodeURIComponent(coinCode)}/sell-orders`, {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success) {
                    showAlert(data.message || `${coinCode} 분할 매도 주문이 시작되었습니다.`, 'success');
                    setTimeout(loadMyCoins, 2000);
                } else {
                    const errorMessage = data.error || data.message || `${coinCode} 매도 주문 요청에 실패했습니다.`;
                    showAlert(`❌ ${errorMessage}`, 'danger');
                }
            } catch (error) {
                showAlert(`❌ ${coinCode} 매도 주문 요청 중 오류 발생: ${error.message}`, 'danger');
            } finally {
                button.disabled = false;
                button.innerHTML = originalContent;
            }
        }

        async function runPerCoinAutomation() {
            if (perCoinAutomationRunning || coinAutomationTaskId) {
                showAlert('이미 코인별 자동 실행이 진행 중입니다.', 'warning');
                return;
            }

            if (!confirm('보유 중인 각 코인에 대해 분석 → 분할 매수 → 분할 매도 요청을 백그라운드에서 실행할까요?')) {
                return;
            }

            perCoinAutomationRunning = true;

            const button = document.getElementById('per-coin-automation-btn');
            const progressWrapper = document.getElementById('per-coin-automation-progress');
            const progressBar = document.getElementById('per-coin-progress-bar');
            const statusEl = document.getElementById('per-coin-automation-status');
            const logEl = document.getElementById('per-coin-automation-log');

            progressWrapper.style.display = 'block';
            progressBar.style.width = '0%';
            progressBar.textContent = '0%';
            statusEl.textContent = '요청을 준비 중입니다...';
            logEl.innerHTML = '';
            if (logEl) {
                delete logEl.dataset.lastMessage;
            }

            button.disabled = true;
            button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 실행 중...';

            try {
                const response = await fetch('/upbit-trading/api/automation/per-coin', {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success && data.task_id) {
                    coinAutomationTaskId = data.task_id;
                    localStorage.setItem(STORAGE_KEYS.COIN_AUTOMATION, data.task_id);
                    statusEl.textContent = '코인별 자동 실행이 시작되었습니다.';

                    if (coinAutomationInterval) {
                        clearInterval(coinAutomationInterval);
                    }
                    coinAutomationInterval = setInterval(checkCoinAutomationProgress, 2000);

                    showAlert(data.message || '코인별 자동 실행이 시작되었습니다.', 'success');
                } else {
                    const message = data.error || data.message || '코인별 자동 실행을 시작하지 못했습니다.';
                    showAlert(`❌ ${message}`, 'danger');
                    resetPerCoinAutomationUI({ clearTask: false });
                }
            } catch (error) {
                showAlert(`❌ 코인별 자동 실행 요청 중 오류 발생: ${error.message}`, 'danger');
                resetPerCoinAutomationUI({ clearTask: false });
            }
        }

        function resetPerCoinAutomationUI(options = {}) {
            const { clearTask = true } = options;

            perCoinAutomationRunning = false;

            if (coinAutomationInterval) {
                clearInterval(coinAutomationInterval);
                coinAutomationInterval = null;
            }

            if (clearTask && coinAutomationTaskId) {
                localStorage.removeItem(STORAGE_KEYS.COIN_AUTOMATION);
                coinAutomationTaskId = null;
            }

            const button = document.getElementById('per-coin-automation-btn');
            if (button) {
                button.disabled = false;
                button.innerHTML = '<i class="bi bi-collection-play"></i> 코인별 분석→매수→매도';
            }

            const logEl = document.getElementById('per-coin-automation-log');
            if (logEl) {
                delete logEl.dataset.lastMessage;
            }
        }

        function updatePerCoinAutomationProgress(progress = {}) {
            const progressBar = document.getElementById('per-coin-progress-bar');
            const statusEl = document.getElementById('per-coin-automation-status');
            const logEl = document.getElementById('per-coin-automation-log');

            if (progressBar && progress.total_steps) {
                const percent = Math.min(
                    100,
                    Math.round(((progress.processed_steps || 0) / progress.total_steps) * 100)
                );
                progressBar.style.width = percent + '%';
                progressBar.textContent = percent + '%';
            }

            if (statusEl) {
                const parts = [];
                if (progress.current_name) {
                    parts.push(progress.current_name);
                }
                if (progress.current_currency) {
                    parts.push(`(${progress.current_currency})`);
                }
                if (progress.current_step) {
                    parts.push(`- ${progress.current_step}`);
                }
                if (progress.step_status) {
                    parts.push(`[${progress.step_status}]`);
                }
                if (parts.length > 0) {
                    statusEl.textContent = parts.join(' ');
                }
            }

            if (logEl && progress.last_message) {
                if (logEl.dataset.lastMessage !== progress.last_message) {
                    logEl.insertAdjacentHTML(
                        'afterbegin',
                        `<div class="mb-2">${escapeHtml(progress.last_message)}</div>`
                    );
                    logEl.dataset.lastMessage = progress.last_message;
                }
            }
        }

        async function checkCoinAutomationProgress() {
            if (!coinAutomationTaskId) {
                return;
            }

            try {
                const response = await fetch(`/upbit-trading/api/analyze-task/${encodeURIComponent(coinAutomationTaskId)}`);
                const data = await response.json();

                if (data.state === 'PROGRESS') {
                    updatePerCoinAutomationProgress(data.progress || {});
                    return;
                }

                if (data.state === 'PENDING') {
                    return;
                }

                if (data.state === 'SUCCESS') {
                    const result = data.result || {};
                    const totalCoins = result.total_coins || 0;

                    updatePerCoinAutomationProgress({
                        processed_steps: totalCoins * 3,
                        total_steps: totalCoins * 3,
                        last_message: '모든 작업이 완료되었습니다.',
                        step_status: 'completed'
                    });

                    const logEl = document.getElementById('per-coin-automation-log');
                    if (logEl && Array.isArray(result.results)) {
                        result.results.forEach((item) => {
                            const coinName = escapeHtml(item.korean_name || item.currency || '-');
                            const stepMessages = (item.steps || [])
                                .map((step) => {
                                    const stepLabel = step.step || '';
                                    const message = step.result?.message || step.result?.error || step.result?.status || '';
                                    return `${stepLabel}: ${escapeHtml(message)}`;
                                })
                                .join('<br>');

                            logEl.insertAdjacentHTML(
                                'afterbegin',
                                `<div class="mb-2"><strong>${coinName}</strong><br>${stepMessages}</div>`
                            );
                        });
                    }

                    showAlert('코인별 자동 실행이 완료되었습니다.', 'success');
                    resetPerCoinAutomationUI();
                    setTimeout(loadMyCoins, 2000);
                    return;
                }

                if (data.state === 'FAILURE') {
                    const errorMessage = data.error || '코인별 자동 실행이 실패했습니다.';
                    showAlert(`❌ ${errorMessage}`, 'danger');
                    resetPerCoinAutomationUI();
                    return;
                }

                resetPerCoinAutomationUI();
            } catch (error) {
                showAlert(`❌ 코인별 자동 실행 상태 확인 중 오류 발생: ${error.message}`, 'danger');
            }
        }
function escapeHtml(value) {
            if (value === undefined || value === null) {
                return '';
            }
            return String(value)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        window.loadMyCoins = loadMyCoins;
        window.runPerCoinAutomation = runPerCoinAutomation;

        function formatLastAnalysisTime(isoString) {
            if (!isoString) {
                return '마지막 분석 기록 없음';
            }
            const date = new Date(isoString);
            if (Number.isNaN(date.getTime())) {
                return '마지막 분석 기록 없음';
            }
            const dateStr = date.toLocaleDateString('ko-KR').replace(/\.\s/g, '.').replace(/\.$/, '');
            const timeStr = date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
            return `마지막 분석: ${dateStr} ${timeStr}`;
        }

        function formatConfidence(confidence) {
            if (confidence === undefined || confidence === null || Number.isNaN(Number(confidence))) {
                return '-';
            }
            return `${Number(confidence).toFixed(1)}%`;
        }

        function formatCoinAmount(value) {
            if (value === undefined || value === null || value === '') {
                return '0';
            }
            const numberValue = Number(value);
            if (!Number.isFinite(numberValue)) {
                return String(value);
            }
            if (Math.abs(numberValue) >= 1) {
                return numberValue.toLocaleString('ko-KR', {
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 8
                });
            }
            const fixed = numberValue.toFixed(8);
            return fixed.replace(/0+$/, '').replace(/\.$/, '') || '0';
        }

        
        function getDecisionBadge(decision) {
            const badges = {
                buy: '<span class="badge bg-success">매수</span>',
                sell: '<span class="badge bg-danger">매도</span>',
                hold: '<span class="badge bg-warning text-dark">보유</span>'
            };
            if (!decision) {
                return '<span class="badge bg-secondary">기록 없음</span>';
            }
            return badges[decision.toLowerCase()] || `<span class="badge bg-secondary">${escapeHtml(decision)}</span>`;
        }

        function formatPriceRange(min, max) {
            if (min === undefined || min === null || max === undefined || max === null) {
                return '-';
            }
            const minValue = Number(min);
            const maxValue = Number(max);
            if (Number.isNaN(minValue) || Number.isNaN(maxValue)) {
                return '-';
            }
            return `${minValue.toLocaleString()} ~ ${maxValue.toLocaleString()}`;
        }

        async function openCoinAnalysisDetail(analysisId, symbol, name) {
            const modalElement = document.getElementById('coinAnalysisModal');
            const modalTitle = modalElement.querySelector('.modal-title');
            const modalBody = modalElement.querySelector('.modal-body');
            const linkElement = document.getElementById('coinAnalysisLink');
            const modal = bootstrap.Modal.getOrCreateInstance(modalElement);

            modalTitle.textContent = `${name} (${symbol}) 분석 상세`;
            modalBody.innerHTML = `
                <div class="text-center text-muted py-4">
                    <div class="spinner-border" role="status"></div>
                </div>
            `;

            if (symbol) {
                linkElement.href = `/stock-latest/?symbol=${encodeURIComponent(symbol)}`;
                linkElement.classList.remove('d-none');
            } else {
                linkElement.classList.add('d-none');
            }

            modal.show();

            try {
                const response = await fetch(`/analysis-json/api/detail/${analysisId}`);
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const data = await response.json();

                if (data.error) {
                    modalBody.innerHTML = `<div class="alert alert-danger">${escapeHtml(data.error)}</div>`;
                    linkElement.classList.add('d-none');
                    return;
                }

                const reasonsHtml = (data.reasons && data.reasons.length > 0)
                    ? data.reasons.map(reason => `<li>${escapeHtml(reason)}</li>`).join('')
                    : '<li class="text-muted">근거 정보가 없습니다.</li>';

                const confidenceLabel = data.confidence !== null && data.confidence !== undefined
                    ? `${Number(data.confidence).toFixed(1)}%`
                    : '-';

                modalBody.innerHTML = `
                    <div class="mb-3">
                        <div class="d-flex flex-wrap align-items-center gap-2">
                            ${getDecisionBadge(data.decision)}
                            <span class="badge bg-light text-dark">신뢰도 ${confidenceLabel}</span>
                        </div>
                        <div class="small text-muted mt-1">${formatLastAnalysisTime(data.created_at)}</div>
                    </div>
                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header py-2"><small class="text-muted">적정 매수 범위</small></div>
                                <div class="card-body py-2">
                                    <strong>${formatPriceRange(data.appropriate_buy_range?.min, data.appropriate_buy_range?.max)}</strong>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header py-2"><small class="text-muted">적정 매도 범위</small></div>
                                <div class="card-body py-2">
                                    <strong>${formatPriceRange(data.appropriate_sell_range?.min, data.appropriate_sell_range?.max)}</strong>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header py-2"><small class="text-muted">희망 매수 범위</small></div>
                                <div class="card-body py-2">
                                    <strong>${formatPriceRange(data.buy_hope_range?.min, data.buy_hope_range?.max)}</strong>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header py-2"><small class="text-muted">목표 매도 범위</small></div>
                                <div class="card-body py-2">
                                    <strong>${formatPriceRange(data.sell_target_range?.min, data.sell_target_range?.max)}</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <h6>핵심 근거</h6>
                        <ol class="ps-3 mb-0">
                            ${reasonsHtml}
                        </ol>
                    </div>
                    ${data.detailed_text ? `
                        <div class="mb-0">
                            <h6>상세 분석</h6>
                            <div class="alert alert-light">
                                <pre class="mb-0" style="white-space: pre-wrap; font-family: inherit;">${escapeHtml(data.detailed_text)}</pre>
                            </div>
                        </div>
                    ` : ''}
                `;
            } catch (error) {
                console.error('분석 상세 로드 실패:', error);
                modalBody.innerHTML = '<div class="alert alert-danger">분석 상세 정보를 불러오는 중 오류가 발생했습니다.</div>';
                linkElement.classList.add('d-none');
            }
        }

        // 알림 표시
        function showAlert(message, type) {
            const alertArea = document.getElementById('alert-area');
            const alertId = 'alert-' + Date.now();

            const alertHtml = `
                <div id="${alertId}" class="alert alert-${type} alert-custom alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;

            alertArea.innerHTML = alertHtml + alertArea.innerHTML;

            // 5초 후 자동 제거
            setTimeout(() => {
                const alert = document.getElementById(alertId);
                if (alert) {
                    alert.remove();
                }
            }, 5000);
        }
    </script>
</body>
</html>
