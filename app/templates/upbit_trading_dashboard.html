<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ request.state.csrf_token | default('', true) }}">
    <title>Upbit 자동 매매 - Auto Trader</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
            padding: 1.2rem;
            margin-bottom: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .stats-number {
            font-size: 1.8rem;
            font-weight: bold;
            margin: 0;
        }

        .stats-label {
            font-size: 0.9rem;
            opacity: 0.9;
            margin: 0;
        }

        .action-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            background: white;
        }

        .action-card h5 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.8rem;
        }

        .action-card p {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 1rem;
        }

        .btn-action {
            width: 100%;
            padding: 0.75rem;
            font-weight: 600;
        }

        .coin-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            background: white;
        }

        .coin-name {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 0.3rem;
        }

        .coin-symbol {
            font-family: monospace;
            color: #666;
            font-size: 0.9rem;
        }

        .coin-info {
            font-size: 0.85rem;
            margin: 0.3rem 0;
        }

        .profit-positive {
            color: #198754;
            font-weight: 600;
        }

        .profit-negative {
            color: #dc3545;
            font-weight: 600;
        }

        .loading-spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .order-item {
            border-left: 3px solid #0d6efd;
            padding: 0.5rem 0.75rem;
            margin-bottom: 0.5rem;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .order-item.sell {
            border-left-color: #dc3545;
        }

        .alert-custom {
            padding: 0.75rem 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }

        .settings-badge {
            cursor: pointer;
            transition: all 0.2s;
        }

        .settings-badge:hover {
            transform: scale(1.05);
        }

        .settings-configured {
            background-color: #198754 !important;
        }

        .settings-not-configured {
            background-color: #6c757d !important;
        }

        .estimated-cost-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
    </style>
</head>

<body>
    {% include 'nav.html' %}

    <div class="container-fluid mt-4">
        <div class="row">
            <!-- 왼쪽: 통계 및 액션 -->
            <div class="col-md-4">
                <h4 class="mb-3">
                    <i class="bi bi-cash-stack"></i> Upbit 자동 매매 대시보드
                </h4>

                <!-- 통계 -->
                <div class="stats-card">
                    <p class="stats-label">KRW 잔고 (사용 가능)</p>
                    <p class="stats-number" id="krw-balance">-</p>
                    <p class="stats-label" style="margin-top: 0.5rem; font-size: 0.75rem;">
                        주문 중: <span id="krw-locked">-</span> | 총: <span id="krw-total">-</span>
                    </p>
                </div>

                <div class="stats-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <p class="stats-label">보유 코인 수</p>
                    <p class="stats-number" id="coin-count">-</p>
                </div>

                <!-- 기본 설정 버튼 -->
                <button id="user-defaults-btn" class="btn btn-outline-secondary w-100 mb-2" onclick="openUserDefaultsModal()">
                    <i class="bi bi-gear-fill"></i> 기본 거래 설정
                </button>

                <!-- 새로고침 버튼 -->
                <button id="refresh-coins-btn" class="btn btn-outline-primary w-100 mb-3">
                    <i class="bi bi-arrow-clockwise"></i> 새로고침
                </button>

                <!-- 액션 카드 0: 코인별 자동 실행 -->
                <div class="action-card">
                    <h5><i class="bi bi-collection-play"></i> 코인별 자동 실행</h5>
                    <p>보유 중인 각 코인에 대해 순서대로 <strong>분석 → 분할 매수 → 분할 매도</strong> 요청을 전송합니다. 요청은 코인 단위로 순차 처리되어 API 쿼터를
                        절약합니다.</p>

                    <button id="per-coin-automation-btn" class="btn btn-outline-primary btn-action">
                        <i class="bi bi-collection-play"></i> 코인별 분석→매수→매도
                    </button>
                </div>

                <!-- 액션 카드 1: AI 분석 -->
                <div class="action-card">
                    <h5><i class="bi bi-robot"></i> AI 분석 실행</h5>
                    <p>보유 코인에 대한 AI 투자 분석을 실행합니다.</p>

                    <button id="analyze-btn" class="btn btn-primary btn-action" onclick="analyzeCoins()">
                        <i class="bi bi-cpu"></i> 분석 시작
                    </button>
                </div>

                <!-- 액션 카드 2: 자동 매수 -->
                <div class="action-card">
                    <h5><i class="bi bi-cart-plus"></i> 자동 매수 주문</h5>
                    <p>AI 분석 결과를 기반으로 분할 매수 주문을 실행합니다.</p>

                    <button id="buy-btn" class="btn btn-success btn-action" onclick="executeBuyOrders()">
                        <i class="bi bi-arrow-down-circle"></i> 매수 주문
                    </button>
                    <div id="total-estimated-cost" class="mt-2 small text-success" style="display: none;">
                        <i class="bi bi-calculator"></i>
                        <span id="estimated-cost-text"></span>
                    </div>
                </div>

                <!-- 액션 카드 3: 자동 매도 -->
                <div class="action-card">
                    <h5><i class="bi bi-cart-dash"></i> 자동 매도 주문</h5>
                    <p>AI 분석 결과를 기반으로 분할 매도 주문을 실행합니다.</p>

                    <button id="sell-btn" class="btn btn-danger btn-action" onclick="executeSellOrders()">
                        <i class="bi bi-arrow-up-circle"></i> 매도 주문
                    </button>
                </div>

                <!-- 액션 카드 4: 미체결 주문 취소 -->
                <div class="action-card">
                    <h5><i class="bi bi-x-circle"></i> 미체결 주문 관리</h5>
                    <p>현재 체결 대기 중인 모든 주문을 조회하거나 취소합니다.</p>
                    <button class="btn btn-outline-secondary btn-action mb-2" onclick="loadOpenOrders()">
                        <i class="bi bi-list-check"></i> 미체결 조회
                    </button>
                    <button class="btn btn-outline-danger btn-action" onclick="cancelAllOrders()">
                        <i class="bi bi-trash"></i> 전체 취소
                    </button>
                </div>
            </div>

            <!-- 오른쪽: 보유 코인 목록 -->
            <div class="col-md-8">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5><i class="bi bi-wallet2"></i> 보유 코인 목록</h5>
                    <span class="badge bg-primary" id="tradable-count">0개</span>
                </div>

                <!-- 알림 영역 -->
                <div id="alert-area"></div>

                <!-- 보유 코인 목록 -->
                <div id="coins-list">
                    <div class="text-center text-muted py-5">
                        <i class="bi bi-wallet2" style="font-size: 3rem;"></i>
                        <p class="mt-3">새로고침 버튼을 눌러 보유 코인을 불러오세요.</p>
                    </div>
                </div>

                <!-- 미체결 주문 영역 -->
                <div id="open-orders-section" style="display: none;">
                    <hr class="my-4">
                    <h5 class="mb-3"><i class="bi bi-hourglass-split"></i> 미체결 주문</h5>
                    <div id="open-orders-list"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 코인 분석 상세 모달 -->
    <div class="modal fade" id="coinAnalysisModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">종목 분석 상세</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center text-muted py-4">
                        <div class="spinner-border" role="status"></div>
                    </div>
                </div>
                <div class="modal-footer d-flex justify-content-between align-items-center">
                    <a href="#" class="btn btn-outline-primary" id="coinAnalysisLink" target="_blank" rel="noopener">
                        <i class="bi bi-box-arrow-up-right"></i> 종목 분석 페이지 이동
                    </a>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 코인 매수 설정 모달 (금액 기반) -->
    <div class="modal fade" id="coinSettingsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-gear"></i> 매수 금액 설정
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="settings-symbol">
                    <input type="hidden" id="settings-id">

                    <div class="mb-3">
                        <label class="form-label fw-bold">코인</label>
                        <div id="settings-coin-info" class="form-control-plaintext"></div>
                    </div>

                    <div class="mb-3">
                        <label for="settings-amount" class="form-label fw-bold">
                            주문당 매수 금액 <span class="text-danger">*</span>
                        </label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="settings-amount"
                                   min="5000" step="1000" placeholder="예: 100000">
                            <span class="input-group-text">원</span>
                        </div>
                        <div class="form-text">
                            AI 분석 결과의 4개 매수 가격대에 각각 이 금액만큼 주문합니다.<br>
                            <small class="text-muted">최소 주문 금액: 5,000원</small>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="settings-note" class="form-label">메모 (선택)</label>
                        <input type="text" class="form-control" id="settings-note"
                               placeholder="예: 장기 보유 목적">
                    </div>

                    <!-- 예상 비용 표시 -->
                    <div id="estimated-cost-section" class="mb-3" style="display: none;">
                        <div class="card estimated-cost-card">
                            <div class="card-body">
                                <h6 class="card-title mb-3">
                                    <i class="bi bi-calculator"></i> 예상 매수 비용
                                </h6>
                                <div id="estimated-cost-details"></div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="settings-active" checked>
                        <label class="form-check-label" for="settings-active">설정 활성화</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-danger" id="settings-delete-btn" style="display: none;">
                        <i class="bi bi-trash"></i> 삭제
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-primary" id="settings-save-btn">
                        <i class="bi bi-check-lg"></i> 저장
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 사용자 기본 설정 모달 -->
    <div class="modal fade" id="userDefaultsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-secondary text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-gear-fill"></i> 기본 거래 설정
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info small mb-3">
                        <i class="bi bi-info-circle"></i>
                        종목별 설정이 없는 경우 아래 기본값이 적용됩니다.
                    </div>

                    <h6 class="border-bottom pb-2 mb-3">
                        <i class="bi bi-currency-bitcoin"></i> 암호화폐
                    </h6>

                    <div class="mb-3">
                        <label for="defaults-crypto-amount" class="form-label">
                            기본 매수 금액 <span class="text-danger">*</span>
                        </label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="defaults-crypto-amount"
                                   min="5000" step="1000" placeholder="10000">
                            <span class="input-group-text">원</span>
                        </div>
                        <div class="form-text">
                            종목 설정이 없는 코인의 기본 매수 금액
                        </div>
                    </div>

                    <div class="mb-4">
                        <label for="defaults-crypto-min" class="form-label">
                            최소 주문 금액
                        </label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="defaults-crypto-min"
                                   min="5000" step="1000" placeholder="5000">
                            <span class="input-group-text">원</span>
                        </div>
                        <div class="form-text">
                            업비트 최소 주문 금액 (기본 5,000원)
                        </div>
                    </div>

                    <h6 class="border-bottom pb-2 mb-3">
                        <i class="bi bi-bank"></i> 주식 (국내/해외)
                    </h6>
                    <div class="alert alert-warning small">
                        <i class="bi bi-exclamation-triangle"></i>
                        <strong>주식은 종목별 설정이 필수입니다.</strong><br>
                        설정이 없는 종목은 매수 주문이 실행되지 않습니다.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-primary" id="defaults-save-btn" onclick="saveUserDefaults()">
                        <i class="bi bi-check-lg"></i> 저장
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let cachedTradableCoins = [];

        function getCsrfToken() {
            const metaTag = document.querySelector('meta[name="csrf-token"]');
            if (metaTag && metaTag.content) {
                return metaTag.content;
            }
            const cookieMatch = document.cookie.match(/(?:^|;\s*)(?:csrftoken|csrf_token)=([^;]+)/);
            if (cookieMatch) {
                try {
                    return decodeURIComponent(cookieMatch[1]);
                } catch (error) {
                    console.warn('Failed to decode CSRF token cookie', error);
                    return cookieMatch[1];
                }
            }
            return '';
        }

        function csrfFetch(url, options = {}) {
            const opts = { ...options };
            const headers = new Headers(opts.headers || {});
            const csrfToken = getCsrfToken();
            if (csrfToken) {
                headers.set('X-CSRF-Token', csrfToken);
            }
            opts.headers = headers;
            return fetch(url, opts);
        }

        // 페이지 로드 시 보유 코인 조회
        document.addEventListener('DOMContentLoaded', async function () {
            const refreshButton = document.getElementById('refresh-coins-btn');
            if (refreshButton) {
                refreshButton.addEventListener('click', () => {
                    loadMyCoins().catch((error) => console.error('loadMyCoins failed', error));
                });
            }

            const automationButton = document.getElementById('per-coin-automation-btn');
            if (automationButton) {
                automationButton.addEventListener('click', () => {
                    runPerCoinAutomation().catch((error) => console.error('runPerCoinAutomation failed', error));
                });
            }

            try {
                await loadMyCoins();
            } catch (error) {
                console.error('loadMyCoins failed', error);
            }
        });

        // 보유 코인 조회
        async function loadMyCoins() {
            try {
                const response = await fetch('/upbit-trading/api/my-coins');
                const data = await response.json();

                if (data.success) {
                    // 통계 업데이트
                    document.getElementById('krw-balance').textContent =
                        new Intl.NumberFormat('ko-KR', { maximumFractionDigits: 0 }).format(data.krw_balance) + '원';
                    document.getElementById('krw-locked').textContent =
                        new Intl.NumberFormat('ko-KR', { maximumFractionDigits: 0 }).format(data.krw_locked) + '원';
                    document.getElementById('krw-total').textContent =
                        new Intl.NumberFormat('ko-KR', { maximumFractionDigits: 0 }).format(data.krw_total) + '원';
                    document.getElementById('coin-count').textContent = data.tradable_coins_count + '개';
                    document.getElementById('tradable-count').textContent = data.tradable_coins_count + '개';

                    cachedTradableCoins = data.coins || [];

                    // 코인 목록 렌더링
                    const coinsList = document.getElementById('coins-list');
                    if (data.coins.length === 0) {
                        coinsList.innerHTML = `
                            <div class="text-center text-muted py-5">
                                <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                                <p class="mt-3">거래 가능한 코인이 없습니다.</p>
                            </div>
                        `;
                    } else {
                        coinsList.innerHTML = data.coins.map(coin => {
                            const profitRate = Number(coin.profit_rate || 0);
                            const profitRatePercent = (profitRate * 100).toFixed(2);
                            const profitClass = profitRate >= 0 ? 'profit-positive' : 'profit-negative';
                            const profitSign = profitRate >= 0 ? '+' : '';
                            const lastAnalysisText = formatLastAnalysisTime(coin.last_analysis_at);
                            const balanceDisplay = coin.balance_display
                                ?? formatCoinAmount(coin.balance_raw ?? coin.balance);
                            const lockedDisplay = coin.locked_display
                                ?? formatCoinAmount(coin.locked_raw ?? coin.locked);
                            const totalDisplay = formatCoinAmount(
                                Number(coin.balance ?? 0) + Number(coin.locked ?? 0)
                            );
                            const analysisMeta = coin.last_analysis_decision
                                ? `<div class="d-flex align-items-center gap-2 flex-wrap mt-1">
                                        ${getDecisionBadge(coin.last_analysis_decision)}
                                        <span class="small text-muted">신뢰도 ${formatConfidence(coin.analysis_confidence)}</span>
                                   </div>`
                                : `<div class="small text-muted mt-1">분석 정보가 없습니다.</div>`;
                            const analysisDetailButton = coin.analysis_id
                                ? `<button
                                        class="btn btn-outline-primary btn-sm coin-analysis-btn"
                                        data-analysis-id="${coin.analysis_id}"
                                        data-symbol="${escapeHtml(coin.market)}"
                                        data-name="${escapeHtml(coin.korean_name)}">
                                        <i class="bi bi-search"></i> 종목 분석 상세
                                   </button>`
                                : `<button class="btn btn-outline-secondary btn-sm" disabled>
                                        <i class="bi bi-search"></i> 분석 기록 없음
                                   </button>`;
                            const analyzeButton = `
                                <button
                                    class="btn btn-outline-info btn-sm coin-analyze-btn"
                                    data-currency="${escapeHtml(coin.currency)}"
                                    data-korean-name="${escapeHtml(coin.korean_name)}"
                                >
                                    <i class="bi bi-robot"></i> 분석 실행
                                </button>
                            `;
                            const buyButton = `
                                <button
                                    class="btn btn-outline-success btn-sm coin-buy-btn"
                                    data-currency="${escapeHtml(coin.currency)}"
                                >
                                    <i class="bi bi-cart-plus"></i> 분할 매수
                                </button>
                            `;
                            const sellButton = `
                                <button
                                    class="btn btn-outline-danger btn-sm coin-sell-btn"
                                    data-currency="${escapeHtml(coin.currency)}"
                                >
                                    <i class="bi bi-cart-dash"></i> 분할 매도
                                </button>
                            `;
                            const settingsConfigured = coin.settings_amount !== null && coin.settings_amount !== undefined;
                            const settingsBadgeClass = settingsConfigured ? 'settings-configured' : 'settings-not-configured';
                            const settingsText = settingsConfigured
                                ? `${Number(coin.settings_amount).toLocaleString()}원`
                                : '미설정';
                            const settingsButton = `
                                <span
                                    class="badge ${settingsBadgeClass} settings-badge coin-settings-btn"
                                    data-market="${escapeHtml(coin.market)}"
                                    data-korean-name="${escapeHtml(coin.korean_name)}"
                                    data-settings-amount="${coin.settings_amount || ''}"
                                    data-settings-note="${escapeHtml(coin.settings_note || '')}"
                                    data-settings-active="${coin.settings_active !== false}"
                                    title="매수 설정 클릭"
                                >
                                    <i class="bi bi-gear-fill"></i> ${settingsText}
                                </span>
                            `;
                            const actionButtons = `
                                <div class="d-flex flex-wrap gap-2 justify-content-lg-end align-items-center">
                                    ${settingsButton}
                                    ${analysisDetailButton}
                                    ${analyzeButton}
                                    ${buyButton}
                                    ${sellButton}
                                </div>
                            `;

                            return `
                                <div class="coin-card">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <div class="coin-name">${escapeHtml(coin.korean_name)}</div>
                                            <div class="coin-symbol">${escapeHtml(coin.currency)} (${escapeHtml(coin.market)})</div>
                                        </div>
                                        <div class="text-end">
                                            <div class="${profitClass}" style="font-size: 1.2rem;">
                                                ${profitSign}${profitRatePercent}%
                                            </div>
                                            <div class="coin-info ${profitClass}">
                        ${profitSign}${new Intl.NumberFormat('ko-KR', { maximumFractionDigits: 0 }).format(Math.trunc(coin.profit_loss))}원
                                            </div>
                                        </div>
                                    </div>
                                    <hr class="my-2">
                                    <div class="row coin-info">
                                        <div class="col-6">매도 가능 수량: ${balanceDisplay}</div>
                                        <div class="col-6 text-end">주문 중: ${lockedDisplay}</div>
                                    </div>
                                    <div class="row coin-info">
                                        <div class="col-6">총 수량: ${totalDisplay}</div>
                                        <div class="col-6 text-end">현재가: ${new Intl.NumberFormat('ko-KR', { maximumFractionDigits: 0 }).format(Math.trunc(coin.current_price))}원</div>
                                    </div>
                                    <div class="row coin-info">
                                        <div class="col-6">평균 단가: ${new Intl.NumberFormat('ko-KR', { maximumFractionDigits: 0 }).format(Math.trunc(coin.avg_buy_price))}원</div>
                                        <div class="col-6 text-end">평가금액: ${new Intl.NumberFormat('ko-KR', { maximumFractionDigits: 0 }).format(Math.trunc(coin.evaluation))}원</div>
                                    </div>
                                    <div class="coin-info mt-3 d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-2">
                                        <div>
                                            <div class="small text-muted">${lastAnalysisText}</div>
                                            ${analysisMeta}
                                        </div>
                                        ${actionButtons}
                                    </div>
                                </div>
                            `;
                        }).join('');
                        attachCoinActionHandlers();
                    }

                    // 예상 매수 비용 로드
                    loadTotalEstimatedCost();
                } else {
                    cachedTradableCoins = [];
                    showAlert('보유 코인 조회 실패: ' + data.error, 'danger');
                }
            } catch (error) {
                cachedTradableCoins = [];
                showAlert('보유 코인 조회 중 오류 발생: ' + error.message, 'danger');
            }
        }

        // 전체 예상 매수 비용 로드
        async function loadTotalEstimatedCost() {
            try {
                const response = await fetch('/api/symbol-settings/symbols/crypto/estimated-cost');
                if (!response.ok) {
                    document.getElementById('total-estimated-cost').style.display = 'none';
                    return;
                }

                const data = await response.json();
                const costDiv = document.getElementById('total-estimated-cost');
                const costText = document.getElementById('estimated-cost-text');

                if (data.total_symbols === 0) {
                    costDiv.style.display = 'none';
                    return;
                }

                // 순 예상 비용 표시 (기존 매수 주문 차감)
                const netCost = new Intl.NumberFormat('ko-KR').format(Math.round(data.net_estimated_cost));
                const grandTotal = new Intl.NumberFormat('ko-KR').format(Math.round(data.grand_total_cost));
                const pendingCost = new Intl.NumberFormat('ko-KR').format(Math.round(data.pending_buy_orders_cost));

                let displayText = `예상: ${netCost}원`;
                if (data.pending_buy_orders_cost > 0) {
                    displayText += ` (총 ${grandTotal}원 - 기존주문 ${pendingCost}원)`;
                }
                displayText += ` / ${data.total_symbols}코인`;

                costText.textContent = displayText;
                costDiv.style.display = 'block';
            } catch (error) {
                console.log('예상 비용 로드 실패:', error);
                document.getElementById('total-estimated-cost').style.display = 'none';
            }
        }

        // AI 분석 실행
        async function analyzeCoins() {
            if (!confirm('보유 코인에 대한 AI 분석을 시작하시겠습니까?')) {
                return;
            }

            const analyzeBtn = document.getElementById('analyze-btn');
            const originalContent = analyzeBtn.innerHTML;
            analyzeBtn.disabled = true;
            analyzeBtn.innerHTML = '<span class="loading-spinner"></span> 실행 중...';

            try {
                const response = await csrfFetch('/upbit-trading/api/analyze-coins', {
                    method: 'POST'
                });
                const data = await response.json();

                if (!response.ok || !data.success) {
                    throw new Error(data.detail || data.error || data.message || '분석 실행 실패');
                }

                showAlert('✅ ' + (data.message || 'AI 분석이 완료되었습니다.'), 'success');
                await loadMyCoins();
            } catch (error) {
                showAlert('분석 실행 중 오류 발생: ' + error.message, 'danger');
            } finally {
                analyzeBtn.disabled = false;
                analyzeBtn.innerHTML = originalContent;
            }
        }

        // 자동 매수 주문
        async function executeBuyOrders() {
            if (!confirm('보유 코인에 대한 자동 매수 주문을 실행하시겠습니까?\n(기존 매수 주문은 취소됩니다)')) {
                return;
            }

            const buyBtn = document.getElementById('buy-btn');
            const originalContent = buyBtn.innerHTML;
            buyBtn.disabled = true;
            buyBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 실행 중...';

            try {
                const response = await csrfFetch('/upbit-trading/api/buy-orders', {
                    method: 'POST'
                });
                const data = await response.json();

                if (!response.ok || !data.success) {
                    throw new Error(data.detail || data.error || data.message || '매수 주문 실행 실패');
                }

                showAlert('✅ ' + (data.message || '자동 매수 주문이 완료되었습니다.'), 'success');
                await loadMyCoins();
            } catch (error) {
                showAlert('매수 주문 중 오류 발생: ' + error.message, 'danger');
            } finally {
                buyBtn.disabled = false;
                buyBtn.innerHTML = originalContent;
            }
        }

        // 자동 매도 주문
        async function executeSellOrders() {
            if (!confirm('보유 코인에 대한 자동 매도 주문을 실행하시겠습니까?\n(기존 매도 주문은 취소됩니다)')) {
                return;
            }

            const sellBtn = document.getElementById('sell-btn');
            const originalContent = sellBtn.innerHTML;
            sellBtn.disabled = true;
            sellBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 실행 중...';

            try {
                const response = await csrfFetch('/upbit-trading/api/sell-orders', {
                    method: 'POST'
                });
                const data = await response.json();

                if (!response.ok || !data.success) {
                    throw new Error(data.detail || data.error || data.message || '매도 주문 실행 실패');
                }

                showAlert('✅ ' + (data.message || '자동 매도 주문이 완료되었습니다.'), 'success');
                await loadMyCoins();
            } catch (error) {
                showAlert('매도 주문 중 오류 발생: ' + error.message, 'danger');
            } finally {
                sellBtn.disabled = false;
                sellBtn.innerHTML = originalContent;
            }
        }

        // 미체결 주문 조회
        async function loadOpenOrders() {
            try {
                showAlert('미체결 주문을 조회 중입니다...', 'info');

                const response = await fetch('/upbit-trading/api/open-orders');
                const data = await response.json();

                if (data.success) {
                    const section = document.getElementById('open-orders-section');
                    const list = document.getElementById('open-orders-list');

                    if (data.orders.length === 0) {
                        showAlert('미체결 주문이 없습니다.', 'info');
                        section.style.display = 'none';
                    } else {
                        showAlert(`미체결 주문 ${data.total_count}개를 찾았습니다.`, 'success');
                        section.style.display = 'block';

                        list.innerHTML = data.orders.map(order => {
                            const isBuy = order.side === 'bid';
                            const sideText = isBuy ? '매수' : '매도';
                            const sideClass = isBuy ? '' : 'sell';
                            const sideIcon = isBuy ? 'arrow-down-circle' : 'arrow-up-circle';
                            const name = escapeHtml(order.korean_name || order.currency || '');
                            const currency = escapeHtml(order.currency || '');
                            const state = escapeHtml(order.state || '');
                            const volume = (order.volume === undefined || order.volume === null)
                                ? '-'
                                : escapeHtml(String(order.volume));
                            const remaining = (order.remaining_volume === undefined || order.remaining_volume === null)
                                ? '-'
                                : escapeHtml(String(order.remaining_volume));
                            let priceDisplay = '-';
                            const numericPrice = Number(order.price);
                            if (Number.isFinite(numericPrice)) {
                                const truncatedPrice = Math.trunc(numericPrice);
                                priceDisplay = `${new Intl.NumberFormat('ko-KR', { maximumFractionDigits: 0 }).format(truncatedPrice)}원`;
                            } else if (order.price !== undefined && order.price !== null) {
                                priceDisplay = escapeHtml(String(order.price));
                            }

                            return `
                                <div class="order-item ${sideClass}">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <i class="bi bi-${sideIcon}"></i>
                                            <strong>${name} (${currency})</strong> - ${sideText}
                                        </div>
                                        <div class="text-end">
                                            <span class="badge bg-secondary">${state}</span>
                                        </div>
                                    </div>
                                    <div class="mt-1" style="font-size: 0.85rem; color: #666;">
                                        가격: ${priceDisplay} | 수량: ${volume} | 미체결: ${remaining}
                                    </div>
                                </div>
                            `;
                        }).join('');
                    }
                } else {
                    showAlert('미체결 주문 조회 실패: ' + data.error, 'danger');
                }
            } catch (error) {
                showAlert('미체결 주문 조회 중 오류 발생: ' + error.message, 'danger');
            }
        }

        // 모든 미체결 주문 취소
        async function cancelAllOrders() {
            if (!confirm('모든 미체결 주문을 취소하시겠습니까?')) {
                return;
            }

            try {
                showAlert('미체결 주문을 취소 중입니다...', 'info', { showSpinner: true });

                const response = await csrfFetch('/upbit-trading/api/cancel-orders', {
                    method: 'DELETE'
                });
                const data = await response.json();

                if (data.success) {
                    const totalCancelled = data.results.reduce((sum, r) => sum + (r.cancelled_count || 0), 0);
                    showAlert(`✅ 총 ${totalCancelled}개 주문이 취소되었습니다.`, 'success');

                    // 미체결 주문 섹션 숨기기
                    document.getElementById('open-orders-section').style.display = 'none';

                    // 보유 코인 새로고침
                    setTimeout(loadMyCoins, 2000);
                } else {
                    showAlert('❌ 주문 취소 실패', 'danger');
                }
            } catch (error) {
                showAlert('주문 취소 중 오류 발생: ' + error.message, 'danger');
            }
        }

        function attachCoinActionHandlers() {
            document.querySelectorAll('.coin-analysis-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const hasAnalysis = button.dataset.analysisId && Number(button.dataset.analysisId) > 0;
                    const symbol = button.dataset.symbol;
                    const name = button.dataset.name;

                    if (!hasAnalysis) {
                        return;
                    }

                    // 항상 최신 분석을 symbol 기반으로 조회
                    openCoinAnalysisDetail(symbol, name);
                });
            });

            document.querySelectorAll('.coin-analyze-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const currency = button.dataset.currency;
                    const koreanName = button.dataset.koreanName;
                    triggerCoinAnalysis(currency, koreanName, button);
                });
            });

            document.querySelectorAll('.coin-buy-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const currency = button.dataset.currency;
                    triggerCoinBuy(currency, button);
                });
            });

            document.querySelectorAll('.coin-sell-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const currency = button.dataset.currency;
                    triggerCoinSell(currency, button);
                });
            });

            document.querySelectorAll('.coin-settings-btn').forEach(badge => {
                badge.addEventListener('click', () => {
                    const market = badge.dataset.market;
                    const koreanName = badge.dataset.koreanName;
                    const amount = badge.dataset.settingsAmount;
                    const note = badge.dataset.settingsNote;
                    const active = badge.dataset.settingsActive !== 'false';
                    openCoinSettingsModal(market, koreanName, amount, note, active);
                });
            });
        }

        async function triggerCoinAnalysis(currency, koreanName, button) {
            if (!currency) return;
            const coinCode = currency.toUpperCase();
            const displayName = koreanName || coinCode;

            if (!confirm(`${displayName} (${coinCode})에 대한 AI 분석을 실행할까요?`)) {
                return;
            }

            const originalContent = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 요청 중...';

            try {
                const response = await csrfFetch(`/upbit-trading/api/coin/${encodeURIComponent(coinCode)}/analysis`, {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success) {
                    showAlert(data.message || `${displayName} 분석이 시작되었습니다.`, 'success');
                } else {
                    const errorMessage = data.error || data.message || `${displayName} 분석 요청에 실패했습니다.`;
                    showAlert(`❌ ${errorMessage}`, 'danger');
                }
            } catch (error) {
                showAlert(`❌ ${displayName} 분석 요청 중 오류 발생: ${error.message}`, 'danger');
            } finally {
                button.disabled = false;
                button.innerHTML = originalContent;
            }
        }

        async function triggerCoinBuy(currency, button) {
            if (!currency) return;
            const coinCode = currency.toUpperCase();

            if (!confirm(`${coinCode}에 대한 분할 매수 주문을 실행할까요? 기존 매수 주문은 취소됩니다.`)) {
                return;
            }

            const originalContent = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 요청 중...';

            try {
                const response = await csrfFetch(`/upbit-trading/api/coin/${encodeURIComponent(coinCode)}/buy-orders`, {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success) {
                    showAlert(data.message || `${coinCode} 분할 매수 주문이 시작되었습니다.`, 'success');
                    setTimeout(loadMyCoins, 2000);
                } else {
                    const errorMessage = data.error || data.message || `${coinCode} 매수 주문 요청에 실패했습니다.`;
                    showAlert(`❌ ${errorMessage}`, 'danger');
                }
            } catch (error) {
                showAlert(`❌ ${coinCode} 매수 주문 요청 중 오류 발생: ${error.message}`, 'danger');
            } finally {
                button.disabled = false;
                button.innerHTML = originalContent;
            }
        }

        async function triggerCoinSell(currency, button) {
            if (!currency) return;
            const coinCode = currency.toUpperCase();

            if (!confirm(`${coinCode}에 대한 분할 매도 주문을 실행할까요? 기존 매도 주문은 취소됩니다.`)) {
                return;
            }

            const originalContent = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 요청 중...';

            try {
                const response = await csrfFetch(`/upbit-trading/api/coin/${encodeURIComponent(coinCode)}/sell-orders`, {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success) {
                    showAlert(data.message || `${coinCode} 분할 매도 주문이 시작되었습니다.`, 'success');
                    setTimeout(loadMyCoins, 2000);
                } else {
                    const errorMessage = data.error || data.message || `${coinCode} 매도 주문 요청에 실패했습니다.`;
                    showAlert(`❌ ${errorMessage}`, 'danger');
                }
            } catch (error) {
                showAlert(`❌ ${coinCode} 매도 주문 요청 중 오류 발생: ${error.message}`, 'danger');
            } finally {
                button.disabled = false;
                button.innerHTML = originalContent;
            }
        }

        async function runPerCoinAutomation() {
            if (!confirm('보유 중인 각 코인에 대해 분석 → 분할 매수 → 분할 매도 요청을 백그라운드에서 실행할까요?')) {
                return;
            }
            const button = document.getElementById('per-coin-automation-btn');
            const originalContent = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 요청 중...';

            try {
                const response = await csrfFetch('/upbit-trading/api/automation/per-coin', {
                    method: 'POST'
                });
                const data = await response.json();

                if (!response.ok || !data.success) {
                    throw new Error(data.detail || data.error || data.message || '코인별 자동 실행 요청에 실패했습니다.');
                }

                showAlert('✅ ' + (data.message || '코인별 자동 실행이 완료되었습니다.'), 'success');
                await loadMyCoins();
            } catch (error) {
                showAlert(`❌ 코인별 자동 실행 요청 중 오류 발생: ${error.message}`, 'danger');
            } finally {
                button.disabled = false;
                button.innerHTML = originalContent;
            }
        }

        function escapeHtml(value) {
            if (value === undefined || value === null) {
                return '';
            }
            return String(value)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        window.loadMyCoins = loadMyCoins;
        window.runPerCoinAutomation = runPerCoinAutomation;

        function formatLastAnalysisTime(isoString) {
            if (!isoString) {
                return '마지막 분석 기록 없음';
            }
            const date = new Date(isoString);
            if (Number.isNaN(date.getTime())) {
                return '마지막 분석 기록 없음';
            }
            const dateStr = date.toLocaleDateString('ko-KR').replace(/\.\s/g, '.').replace(/\.$/, '');
            const timeStr = date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
            return `마지막 분석: ${dateStr} ${timeStr}`;
        }

        function formatConfidence(confidence) {
            if (confidence === undefined || confidence === null || Number.isNaN(Number(confidence))) {
                return '-';
            }
            return `${Number(confidence).toFixed(1)}%`;
        }

        function formatCoinAmount(value) {
            if (value === undefined || value === null || value === '') {
                return '0';
            }
            const numberValue = Number(value);
            if (!Number.isFinite(numberValue)) {
                return String(value);
            }
            if (Math.abs(numberValue) >= 1) {
                return numberValue.toLocaleString('ko-KR', {
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 8
                });
            }
            const fixed = numberValue.toFixed(8);
            return fixed.replace(/0+$/, '').replace(/\.$/, '') || '0';
        }


        function getDecisionBadge(decision) {
            const badges = {
                buy: '<span class="badge bg-success">매수</span>',
                sell: '<span class="badge bg-danger">매도</span>',
                hold: '<span class="badge bg-warning text-dark">보유</span>'
            };
            if (!decision) {
                return '<span class="badge bg-secondary">기록 없음</span>';
            }
            return badges[decision.toLowerCase()] || `<span class="badge bg-secondary">${escapeHtml(decision)}</span>`;
        }

        function formatPriceRange(min, max) {
            if (min === undefined || min === null || max === undefined || max === null) {
                return '-';
            }
            const minValue = Number(min);
            const maxValue = Number(max);
            if (Number.isNaN(minValue) || Number.isNaN(maxValue)) {
                return '-';
            }
            return `${minValue.toLocaleString()} ~ ${maxValue.toLocaleString()}`;
        }

        async function openCoinAnalysisDetail(symbol, name) {
            const modalElement = document.getElementById('coinAnalysisModal');
            const modalTitle = modalElement.querySelector('.modal-title');
            const modalBody = modalElement.querySelector('.modal-body');
            const linkElement = document.getElementById('coinAnalysisLink');
            const modal = bootstrap.Modal.getOrCreateInstance(modalElement);

            modalTitle.textContent = `${name} (${symbol}) 분석 상세`;
            modalBody.innerHTML = `
                <div class="text-center text-muted py-4">
                    <div class="spinner-border" role="status"></div>
                </div>
            `;

            if (symbol) {
                linkElement.href = `/stock-latest/?symbol=${encodeURIComponent(symbol)}`;
                linkElement.classList.remove('d-none');
            } else {
                linkElement.classList.add('d-none');
            }

            modal.show();

            try {
                // symbol 기반으로 최신 분석 결과를 조회
                const response = await fetch(`/analysis-json/api/detail/by-symbol/${encodeURIComponent(symbol)}`);
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const data = await response.json();

                if (data.error) {
                    modalBody.innerHTML = `<div class="alert alert-danger">${escapeHtml(data.error)}</div>`;
                    linkElement.classList.add('d-none');
                    return;
                }

                const reasonsHtml = (data.reasons && data.reasons.length > 0)
                    ? data.reasons.map(reason => `<li>${escapeHtml(reason)}</li>`).join('')
                    : '<li class="text-muted">근거 정보가 없습니다.</li>';

                const confidenceLabel = data.confidence !== null && data.confidence !== undefined
                    ? `${Number(data.confidence).toFixed(1)}%`
                    : '-';

                modalBody.innerHTML = `
                    <div class="mb-3">
                        <div class="d-flex flex-wrap align-items-center gap-2">
                            ${getDecisionBadge(data.decision)}
                            <span class="badge bg-light text-dark">신뢰도 ${confidenceLabel}</span>
                        </div>
                        <div class="small text-muted mt-1">${formatLastAnalysisTime(data.created_at)}</div>
                    </div>
                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header py-2"><small class="text-muted">적정 매수 범위</small></div>
                                <div class="card-body py-2">
                                    <strong>${formatPriceRange(data.appropriate_buy_range?.min, data.appropriate_buy_range?.max)}</strong>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header py-2"><small class="text-muted">적정 매도 범위</small></div>
                                <div class="card-body py-2">
                                    <strong>${formatPriceRange(data.appropriate_sell_range?.min, data.appropriate_sell_range?.max)}</strong>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header py-2"><small class="text-muted">희망 매수 범위</small></div>
                                <div class="card-body py-2">
                                    <strong>${formatPriceRange(data.buy_hope_range?.min, data.buy_hope_range?.max)}</strong>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header py-2"><small class="text-muted">목표 매도 범위</small></div>
                                <div class="card-body py-2">
                                    <strong>${formatPriceRange(data.sell_target_range?.min, data.sell_target_range?.max)}</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <h6>핵심 근거</h6>
                        <ol class="ps-3 mb-0">
                            ${reasonsHtml}
                        </ol>
                    </div>
                    ${data.detailed_text ? `
                        <div class="mb-0">
                            <h6>상세 분석</h6>
                            <div class="alert alert-light">
                                <pre class="mb-0" style="white-space: pre-wrap; font-family: inherit;">${escapeHtml(data.detailed_text)}</pre>
                            </div>
                        </div>
                    ` : ''}
                `;
            } catch (error) {
                console.error('분석 상세 로드 실패:', error);
                modalBody.innerHTML = '<div class="alert alert-danger">분석 상세 정보를 불러오는 중 오류가 발생했습니다.</div>';
                linkElement.classList.add('d-none');
            }
        }

        // ===== Coin Settings Modal Functions =====

        function openCoinSettingsModal(market, koreanName, amount, note, active) {
            const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('coinSettingsModal'));

            document.getElementById('settings-symbol').value = market;
            document.getElementById('settings-coin-info').innerHTML = `<strong>${koreanName}</strong> <small class="text-muted">(${market})</small>`;
            document.getElementById('settings-amount').value = amount || '';
            document.getElementById('settings-note').value = note || '';
            document.getElementById('settings-active').checked = active;

            // Show/hide delete button based on whether settings exist
            const deleteBtn = document.getElementById('settings-delete-btn');
            if (amount) {
                deleteBtn.style.display = 'block';
            } else {
                deleteBtn.style.display = 'none';
            }

            // Hide estimated cost section initially
            document.getElementById('estimated-cost-section').style.display = 'none';

            // Load estimated cost if analysis exists
            loadCoinEstimatedCost(market);

            modal.show();
        }

        async function loadCoinEstimatedCost(market) {
            try {
                const response = await fetch(`/api/symbol-settings/symbols/${encodeURIComponent(market)}/estimated-cost`);
                if (response.ok) {
                    const data = await response.json();
                    displayCoinEstimatedCost(data);
                }
                // If 404 or other error, just don't show the section
            } catch (error) {
                console.log('No estimated cost available:', error);
            }
        }

        function displayCoinEstimatedCost(data) {
            const section = document.getElementById('estimated-cost-section');
            const details = document.getElementById('estimated-cost-details');

            let pricesHtml = data.buy_prices.map(p => `
                <div class="d-flex justify-content-between small mb-1">
                    <span>${p.price_name.replace(/_/g, ' ')}</span>
                    <span>${Number(p.price).toLocaleString()}원 × ${Number(p.quantity).toFixed(8)}개 = ${Number(p.cost).toLocaleString()}원</span>
                </div>
            `).join('');

            details.innerHTML = `
                ${pricesHtml}
                <hr class="my-2" style="border-color: rgba(255,255,255,0.3);">
                <div class="d-flex justify-content-between fw-bold">
                    <span>총 예상 비용</span>
                    <span>${Number(data.total_cost).toLocaleString()}원</span>
                </div>
            `;

            section.style.display = 'block';
        }

        async function saveCoinSettings() {
            const market = document.getElementById('settings-symbol').value;
            const amount = parseFloat(document.getElementById('settings-amount').value);
            const note = document.getElementById('settings-note').value;
            const isActive = document.getElementById('settings-active').checked;

            if (!amount || amount < 5000) {
                showAlert('매수 금액을 5,000원 이상 입력해주세요.', 'warning');
                return;
            }

            try {
                // Check if settings exist
                const checkResponse = await fetch(`/api/symbol-settings/symbols/${encodeURIComponent(market)}`);
                const settingsExist = checkResponse.ok;

                let response;
                if (settingsExist) {
                    // Update existing
                    response = await csrfFetch(`/api/symbol-settings/symbols/${encodeURIComponent(market)}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            buy_quantity_per_order: amount,
                            note: note || null,
                            is_active: isActive
                        })
                    });
                } else {
                    // Create new
                    response = await csrfFetch('/api/symbol-settings/symbols', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            symbol: market,
                            instrument_type: 'crypto',
                            buy_quantity_per_order: amount,
                            note: note || null
                        })
                    });
                }

                if (response.ok) {
                    showAlert(`✅ ${market} 설정이 저장되었습니다.`, 'success');
                    bootstrap.Modal.getInstance(document.getElementById('coinSettingsModal')).hide();
                    loadMyCoins(); // Refresh list
                } else {
                    const error = await response.json();
                    showAlert(`❌ 저장 실패: ${error.detail || '알 수 없는 오류'}`, 'danger');
                }
            } catch (error) {
                showAlert(`❌ 저장 중 오류 발생: ${error.message}`, 'danger');
            }
        }

        async function deleteCoinSettings() {
            const market = document.getElementById('settings-symbol').value;

            if (!confirm(`${market} 코인의 매수 설정을 삭제하시겠습니까?`)) {
                return;
            }

            try {
                const response = await csrfFetch(`/api/symbol-settings/symbols/${encodeURIComponent(market)}`, {
                    method: 'DELETE'
                });

                if (response.ok || response.status === 204) {
                    showAlert(`✅ ${market} 설정이 삭제되었습니다.`, 'success');
                    bootstrap.Modal.getInstance(document.getElementById('coinSettingsModal')).hide();
                    loadMyCoins();
                } else {
                    showAlert('❌ 삭제 실패', 'danger');
                }
            } catch (error) {
                showAlert(`❌ 삭제 중 오류 발생: ${error.message}`, 'danger');
            }
        }

        // Attach modal button handlers
        document.getElementById('settings-save-btn').addEventListener('click', saveCoinSettings);
        document.getElementById('settings-delete-btn').addEventListener('click', deleteCoinSettings);

        // ==========================================
        // 사용자 기본 설정 관련 함수
        // ==========================================

        async function openUserDefaultsModal() {
            try {
                const response = await fetch('/api/symbol-settings/user-defaults', {
                    headers: { 'X-CSRF-Token': getCsrfToken() }
                });

                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('defaults-crypto-amount').value = data.crypto_default_buy_amount || 10000;
                    document.getElementById('defaults-crypto-min').value = data.crypto_min_order_amount || 5000;
                } else if (response.status === 401) {
                    showAlert('로그인이 필요합니다.', 'warning');
                    return;
                } else {
                    // 설정이 없으면 기본값 표시
                    document.getElementById('defaults-crypto-amount').value = 10000;
                    document.getElementById('defaults-crypto-min').value = 5000;
                }

                const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('userDefaultsModal'));
                modal.show();
            } catch (error) {
                console.error('Error loading user defaults:', error);
                showAlert('기본 설정을 불러오는 중 오류가 발생했습니다.', 'danger');
            }
        }

        async function saveUserDefaults() {
            const cryptoAmount = parseFloat(document.getElementById('defaults-crypto-amount').value);
            const cryptoMin = parseFloat(document.getElementById('defaults-crypto-min').value);

            if (!cryptoAmount || cryptoAmount < 5000) {
                showAlert('기본 매수 금액은 5,000원 이상이어야 합니다.', 'warning');
                return;
            }

            if (!cryptoMin || cryptoMin < 5000) {
                showAlert('최소 주문 금액은 5,000원 이상이어야 합니다.', 'warning');
                return;
            }

            try {
                const response = await fetch('/api/symbol-settings/user-defaults', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': getCsrfToken()
                    },
                    body: JSON.stringify({
                        crypto_default_buy_amount: cryptoAmount,
                        crypto_min_order_amount: cryptoMin
                    })
                });

                if (response.ok) {
                    showAlert('기본 설정이 저장되었습니다.', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('userDefaultsModal')).hide();
                } else if (response.status === 401) {
                    showAlert('로그인이 필요합니다.', 'warning');
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    showAlert(errorData.detail || '설정 저장에 실패했습니다.', 'danger');
                }
            } catch (error) {
                console.error('Error saving user defaults:', error);
                showAlert('설정 저장 중 오류가 발생했습니다.', 'danger');
            }
        }

        // 알림 표시
        function showAlert(message, type, options = {}) {
            const alertArea = document.getElementById('alert-area');
            if (!alertArea) {
                console.warn('Alert area element not found');
                return;
            }

            const alertElement = document.createElement('div');
            const alertId = `alert-${Date.now()}`;
            alertElement.id = alertId;
            alertElement.className = `alert alert-${type} alert-custom alert-dismissible fade show`;
            alertElement.setAttribute('role', 'alert');

            if (options.showSpinner) {
                const spinner = document.createElement('span');
                spinner.className = 'loading-spinner me-2';
                spinner.setAttribute('aria-hidden', 'true');
                alertElement.appendChild(spinner);
            }

            const messageNode = document.createElement('span');
            messageNode.textContent = String(message ?? '');
            alertElement.appendChild(messageNode);

            const closeButton = document.createElement('button');
            closeButton.type = 'button';
            closeButton.className = 'btn-close';
            closeButton.setAttribute('data-bs-dismiss', 'alert');
            closeButton.setAttribute('aria-label', '닫기');
            alertElement.appendChild(closeButton);

            if (typeof alertArea.prepend === 'function') {
                alertArea.prepend(alertElement);
            } else {
                alertArea.insertBefore(alertElement, alertArea.firstChild);
            }

            const duration = typeof options.duration === 'number' ? options.duration : 5000;
            if (duration > 0) {
                setTimeout(() => {
                    alertElement.remove();
                }, duration);
            }
        }
    </script>
</body>

</html>
