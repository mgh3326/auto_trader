<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KIS 국내주식 자동 매매</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <style>
        .profit-plus {
            color: #d60000;
        }

        /* 국내주식 상승은 빨강 */
        .profit-minus {
            color: #0051c7;
        }

        /* 국내주식 하락은 파랑 */
        .loading-spinner {
            width: 1rem;
            height: 1rem;
            border: 0.2em solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spinner-border .75s linear infinite;
        }

        .card {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: none;
            margin-bottom: 1.5rem;
        }

        .card-header {
            background-color: #fff;
            border-bottom: 1px solid #eee;
            font-weight: 600;
        }

        .btn-action {
            width: 100%;
            margin-bottom: 0.5rem;
        }

        #alert-area {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            width: 350px;
        }

        .alert-custom {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border: none;
        }

        .order-item {
            border-bottom: 1px solid #eee;
            padding: 10px 0;
        }

        .order-item:last-child {
            border-bottom: none;
        }

        .order-item.sell {
            background-color: #f8f9fa;
        }
    </style>
</head>

<body class="bg-light">
    {% include 'nav.html' %}

    <div class="container py-4">
        <div id="alert-area"></div>

        <div class="row mb-4">
            <div class="col-12">
                <h2 class="mb-3">
                    <i class="bi bi-graph-up-arrow text-primary"></i> KIS 국내주식 자동 매매
                </h2>
                <div class="card">
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-4 mb-3 mb-md-0">
                                <h5 class="text-muted">총 보유 자산 (예수금)</h5>
                                <h3 id="krw-balance" class="fw-bold">- 원</h3>
                            </div>
                            <div class="col-md-4 mb-3 mb-md-0">
                                <h5 class="text-muted">보유 종목 수</h5>
                                <h3 id="stock-count" class="fw-bold">- 개</h3>
                            </div>
                            <div class="col-md-4">
                                <h5 class="text-muted">총 평가 금액</h5>
                                <h3 id="total-evaluation" class="fw-bold">- 원</h3>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-robot"></i> 자동 매매 제어</span>
                    </div>
                    <div class="card-body">
                        <div class="row g-2">
                            <div class="col-md-3">
                                <button id="analyze-btn" class="btn btn-primary btn-action" onclick="analyzeStocks()">
                                    <i class="bi bi-search"></i> 전체 종목 AI 분석
                                </button>
                                <div id="analyze-progress" class="progress mt-2" style="height: 20px; display: none;">
                                    <div id="analyze-progress-bar"
                                        class="progress-bar progress-bar-striped progress-bar-animated"
                                        role="progressbar" style="width: 0%">0%</div>
                                </div>
                                <small id="analyze-status" class="text-muted d-block mt-1"></small>
                            </div>
                            <div class="col-md-3">
                                <button id="buy-btn" class="btn btn-success btn-action" onclick="executeBuyOrders()">
                                    <i class="bi bi-cart-plus"></i> 자동 매수 주문
                                </button>
                                <div id="buy-progress" class="progress mt-2" style="height: 20px; display: none;">
                                    <div id="buy-progress-bar"
                                        class="progress-bar progress-bar-striped progress-bar-animated bg-success"
                                        role="progressbar" style="width: 0%">0%</div>
                                </div>
                                <small id="buy-status" class="text-muted d-block mt-1"></small>
                            </div>
                            <div class="col-md-3">
                                <button id="sell-btn" class="btn btn-danger btn-action" onclick="executeSellOrders()">
                                    <i class="bi bi-cart-dash"></i> 자동 매도 주문
                                </button>
                                <div id="sell-progress" class="progress mt-2" style="height: 20px; display: none;">
                                    <div id="sell-progress-bar"
                                        class="progress-bar progress-bar-striped progress-bar-animated bg-danger"
                                        role="progressbar" style="width: 0%">0%</div>
                                </div>
                                <small id="sell-status" class="text-muted d-block mt-1"></small>
                            </div>
                            <div class="col-md-3">
                                <button id="per-stock-automation-btn" class="btn btn-warning text-dark btn-action"
                                    onclick="runPerStockAutomation()">
                                    <i class="bi bi-collection-play"></i> 종목별 분석→매수→매도
                                </button>
                            </div>
                        </div>

                        <!-- 종목별 자동 실행 진행상황 -->
                        <div id="per-stock-automation-progress" class="mt-3 p-3 bg-light rounded border"
                            style="display: none;">
                            <h6 class="border-bottom pb-2 mb-2">종목별 자동 실행 진행상황</h6>
                            <div class="progress mb-2" style="height: 20px;">
                                <div id="per-stock-progress-bar"
                                    class="progress-bar progress-bar-striped progress-bar-animated bg-warning text-dark"
                                    role="progressbar" style="width: 0%">0%</div>
                            </div>
                            <div id="per-stock-automation-status" class="small fw-bold mb-2 text-primary"></div>
                            <div id="per-stock-automation-log" class="small text-muted"
                                style="max-height: 150px; overflow-y: auto; font-family: monospace; background: #fff; padding: 10px; border: 1px solid #ddd;">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-list-ul"></i> 보유 종목 목록</span>
                        <button class="btn btn-sm btn-outline-secondary" onclick="loadMyStocks()">
                            <i class="bi bi-arrow-clockwise"></i> 새로고침
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>종목명 (코드)</th>
                                        <th class="text-end">보유수량</th>
                                        <th class="text-end">평균단가</th>
                                        <th class="text-end">현재가</th>
                                        <th class="text-end">평가금액</th>
                                        <th class="text-end">평가손익 (수익률)</th>
                                        <th class="text-center">AI 분석</th>
                                        <th class="text-center">관리</th>
                                    </tr>
                                </thead>
                                <tbody id="stocks-list">
                                    <tr>
                                        <td colspan="8" class="text-center py-4">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Analysis Detail Modal -->
    <div class="modal fade" id="stockAnalysisModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">AI 분석 상세</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Content loaded via JS -->
                </div>
                <div class="modal-footer">
                    <a href="#" id="stockAnalysisLink" class="btn btn-outline-primary d-none" target="_blank">차트 보기</a>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 전역 변수 및 상수
        const STORAGE_KEYS = {
            ANALYZE: 'kis_domestic_analyze_task_id',
            BUY: 'kis_domestic_buy_task_id',
            SELL: 'kis_domestic_sell_task_id',
            STOCK_AUTOMATION: 'kis_domestic_stock_automation_task_id'
        };

        let analyzeTaskId = localStorage.getItem(STORAGE_KEYS.ANALYZE);
        let buyTaskId = localStorage.getItem(STORAGE_KEYS.BUY);
        let sellTaskId = localStorage.getItem(STORAGE_KEYS.SELL);
        let stockAutomationTaskId = localStorage.getItem(STORAGE_KEYS.STOCK_AUTOMATION);

        let analyzeCheckInterval = null;
        let buyCheckInterval = null;
        let sellCheckInterval = null;
        let stockAutomationInterval = null;

        let analyzePendingCount = 0;
        let buyPendingCount = 0;
        let sellPendingCount = 0;
        let stockAutomationPendingCount = 0;

        let perStockAutomationRunning = false;

        // 초기화
        document.addEventListener('DOMContentLoaded', () => {
            loadMyStocks();

            // 복구: 새로고침 후에도 진행 중인 작업 상태 확인
            if (analyzeTaskId) {
                document.getElementById('analyze-btn').disabled = true;
                document.getElementById('analyze-progress').style.display = 'block';
                analyzeCheckInterval = setInterval(checkAnalyzeProgress, 1000);
            }
            if (buyTaskId) {
                document.getElementById('buy-btn').disabled = true;
                document.getElementById('buy-progress').style.display = 'block';
                buyCheckInterval = setInterval(checkBuyProgress, 1000);
            }
            if (sellTaskId) {
                document.getElementById('sell-btn').disabled = true;
                document.getElementById('sell-progress').style.display = 'block';
                sellCheckInterval = setInterval(checkSellProgress, 1000);
            }
            if (stockAutomationTaskId) {
                perStockAutomationRunning = true;
                const progressWrapper = document.getElementById('per-stock-automation-progress');
                progressWrapper.style.display = 'block';
                document.getElementById('per-stock-automation-btn').disabled = true;
                document.getElementById('per-stock-automation-btn').innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 실행 중...';
                stockAutomationInterval = setInterval(checkStockAutomationProgress, 2000);
            }
        });

        // CSRF Fetch Helper (if needed, currently using standard fetch as auth is cookie/header based via middleware)
        // Assuming standard fetch works with existing auth setup
        async function csrfFetch(url, options = {}) {
            return fetch(url, options);
        }

        // 보유 주식 조회
        async function loadMyStocks() {
            try {
                const response = await fetch('/kis-domestic-trading/api/my-stocks');
                const data = await response.json();

                if (data.success) {
                    // 잔고 업데이트
                    document.getElementById('krw-balance').textContent =
                        new Intl.NumberFormat('ko-KR').format(data.krw_balance) + ' 원';
                    document.getElementById('stock-count').textContent = data.total_stocks + ' 개';

                    const list = document.getElementById('stocks-list');

                    if (data.stocks.length === 0) {
                        list.innerHTML = '<tr><td colspan="8" class="text-center py-4">보유 중인 주식이 없습니다.</td></tr>';
                        document.getElementById('total-evaluation').textContent = '0 원';
                        return;
                    }

                    let totalEval = 0;

                    list.innerHTML = data.stocks.map(stock => {
                        totalEval += stock.evaluation;

                        const profitClass = stock.profit_rate > 0 ? 'profit-plus' : (stock.profit_rate < 0 ? 'profit-minus' : '');
                        const profitSign = stock.profit_rate > 0 ? '+' : '';
                        const profitRatePercent = (stock.profit_rate * 100).toFixed(2);

                        // Analysis status
                        let analysisBadge = '<span class="badge bg-secondary">미분석</span>';
                        if (stock.analysis_id) {
                            analysisBadge = getDecisionBadge(stock.last_analysis_decision);
                        }

                        let analysisButton = `
                            <button class="btn btn-sm btn-outline-primary stock-analyze-btn" 
                                data-id="${stock.analysis_id || ''}" 
                                data-code="${stock.code}" 
                                data-name="${stock.name}">
                                <i class="bi bi-cpu"></i> 분석
                            </button>
                        `;

                        return `
                            <tr>
                                <td>
                                    <strong>${stock.name}</strong>
                                    <br><small class="text-muted">${stock.code}</small>
                                </td>
                                <td class="text-end">${stock.quantity.toLocaleString()} 주</td>
                                <td class="text-end">${stock.avg_price.toLocaleString()} 원</td>
                                <td class="text-end">${stock.current_price.toLocaleString()} 원</td>
                                <td class="text-end">${stock.evaluation.toLocaleString()} 원</td>
                                <td class="text-end ${profitClass}">
                                    ${stock.profit_loss.toLocaleString()} 원<br>
                                    (${profitSign}${profitRatePercent}%)
                                </td>
                                <td class="text-center">
                                    ${analysisBadge}
                                </td>
                                <td class="text-center">
                                    <div class="btn-group btn-group-sm">
                                        ${analysisButton}
                                        <button class="btn btn-outline-success stock-buy-btn" data-code="${stock.code}">매수</button>
                                        <button class="btn btn-outline-danger stock-sell-btn" data-code="${stock.code}">매도</button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    }).join('');

                    document.getElementById('total-evaluation').textContent =
                        new Intl.NumberFormat('ko-KR').format(totalEval) + ' 원';

                    attachStockActionHandlers();
                } else {
                    showAlert('보유 주식 조회 실패: ' + (data.error || 'Unknown error'), 'danger');
                }
            } catch (error) {
                console.error('Error loading stocks:', error);
                showAlert('보유 주식 정보를 불러오는 중 오류가 발생했습니다.', 'danger');
            }
        }

        // 전체 분석 실행
        async function analyzeStocks() {
            if (!confirm('보유 중인 모든 종목에 대해 AI 분석을 실행하시겠습니까?')) {
                return;
            }

            try {
                const analyzeBtn = document.getElementById('analyze-btn');
                const analyzeProgress = document.getElementById('analyze-progress');
                const analyzeProgressBar = document.getElementById('analyze-progress-bar');
                const analyzeStatus = document.getElementById('analyze-status');

                analyzeBtn.disabled = true;
                analyzeProgress.style.display = 'block';
                analyzeProgressBar.style.width = '0%';
                analyzeProgressBar.textContent = '0%';
                analyzeStatus.textContent = '분석 요청 중...';

                const response = await csrfFetch('/kis-domestic-trading/api/analyze-stocks', {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success && data.task_id) {
                    analyzeTaskId = data.task_id;
                    localStorage.setItem(STORAGE_KEYS.ANALYZE, data.task_id);
                    showAlert('✅ ' + data.message, 'success');
                    analyzeCheckInterval = setInterval(checkAnalyzeProgress, 1000);
                } else {
                    showAlert('❌ 분석 요청 실패', 'danger');
                    analyzeBtn.disabled = false;
                    analyzeProgress.style.display = 'none';
                }
            } catch (error) {
                showAlert('분석 요청 중 오류 발생: ' + error.message, 'danger');
                document.getElementById('analyze-btn').disabled = false;
                document.getElementById('analyze-progress').style.display = 'none';
            }
        }

        async function checkAnalyzeProgress() {
            if (!analyzeTaskId) return;

            try {
                const response = await fetch(`/kis-domestic-trading/api/analyze-task/${analyzeTaskId}`);
                const data = await response.json();

                const analyzeProgressBar = document.getElementById('analyze-progress-bar');
                const analyzeStatus = document.getElementById('analyze-status');

                if (data.state === 'PENDING') {
                    analyzePendingCount++;
                    if (analyzeStatus) {
                        if (analyzePendingCount > 5) {
                            analyzeStatus.innerHTML = '대기 시간이 길어지고 있습니다. <a href="#" onclick="localStorage.removeItem(STORAGE_KEYS.ANALYZE); location.reload(); return false;">상태 초기화</a>';
                        } else {
                            analyzeStatus.textContent = '작업 대기 중... (서버 응답 대기)';
                        }
                    }
                    return;
                }
                analyzePendingCount = 0;

                if (data.state === 'PROGRESS' && data.progress) {
                    const percentage = data.progress.percentage || 0;
                    analyzeProgressBar.style.width = percentage + '%';
                    analyzeProgressBar.textContent = percentage + '%';
                    analyzeStatus.textContent = data.progress.status || '분석 진행 중...';
                } else if (data.state === 'SUCCESS') {
                    clearInterval(analyzeCheckInterval);
                    analyzeTaskId = null;
                    localStorage.removeItem(STORAGE_KEYS.ANALYZE);

                    analyzeProgressBar.style.width = '100%';
                    analyzeProgressBar.textContent = '100%';
                    analyzeStatus.textContent = '완료!';

                    if (data.result) {
                        const message = data.result.message || `${data.result.analyzed_count}/${data.result.total_count}개 종목 분석 완료`;
                        showAlert('✅ ' + message, 'success');
                    }

                    setTimeout(() => {
                        document.getElementById('analyze-btn').disabled = false;
                        document.getElementById('analyze-progress').style.display = 'none';
                        loadMyStocks();
                    }, 2000);
                } else if (data.state === 'FAILURE') {
                    clearInterval(analyzeCheckInterval);
                    analyzeTaskId = null;
                    localStorage.removeItem(STORAGE_KEYS.ANALYZE);
                    showAlert('❌ 분석 실패: ' + (data.result?.error || '알 수 없는 오류'), 'danger');
                    document.getElementById('analyze-btn').disabled = false;
                    document.getElementById('analyze-progress').style.display = 'none';
                }
            } catch (error) {
                console.error('Progress check error:', error);
            }
        }

        // 자동 매수 주문 (Placeholder logic)
        async function executeBuyOrders() {
            if (!confirm('보유 종목에 대한 자동 매수 주문을 실행하시겠습니까?')) {
                return;
            }
            // Implementation similar to analyzeStocks but calling /api/buy-orders
            // For brevity, using generic structure
            triggerTask('buy', '/kis-domestic-trading/api/buy-orders', STORAGE_KEYS.BUY);
        }

        // 자동 매도 주문 (Placeholder logic)
        async function executeSellOrders() {
            if (!confirm('보유 종목에 대한 자동 매도 주문을 실행하시겠습니까?')) {
                return;
            }
            triggerTask('sell', '/kis-domestic-trading/api/sell-orders', STORAGE_KEYS.SELL);
        }

        // Generic task trigger
        async function triggerTask(type, url, storageKey) {
            try {
                const btn = document.getElementById(`${type}-btn`);
                const progress = document.getElementById(`${type}-progress`);
                const progressBar = document.getElementById(`${type}-progress-bar`);
                const status = document.getElementById(`${type}-status`);

                btn.disabled = true;
                progress.style.display = 'block';
                progressBar.style.width = '0%';
                progressBar.textContent = '0%';
                status.textContent = '요청 중...';

                const response = await csrfFetch(url, { method: 'POST' });
                const data = await response.json();

                if (data.success && data.task_id) {
                    if (type === 'buy') buyTaskId = data.task_id;
                    if (type === 'sell') sellTaskId = data.task_id;

                    localStorage.setItem(storageKey, data.task_id);
                    showAlert('✅ ' + data.message, 'success');

                    if (type === 'buy') buyCheckInterval = setInterval(checkBuyProgress, 1000);
                    if (type === 'sell') sellCheckInterval = setInterval(checkSellProgress, 1000);
                } else {
                    showAlert('❌ 요청 실패', 'danger');
                    btn.disabled = false;
                    progress.style.display = 'none';
                }
            } catch (error) {
                showAlert('요청 중 오류 발생: ' + error.message, 'danger');
                document.getElementById(`${type}-btn`).disabled = false;
                document.getElementById(`${type}-progress`).style.display = 'none';
            }
        }

        async function checkBuyProgress() {
            checkGenericProgress(buyTaskId, 'buy', buyCheckInterval, STORAGE_KEYS.BUY);
        }

        async function checkSellProgress() {
            checkGenericProgress(sellTaskId, 'sell', sellCheckInterval, STORAGE_KEYS.SELL);
        }

        async function checkGenericProgress(taskId, type, intervalId, storageKey) {
            if (!taskId) return;
            try {
                const response = await fetch(`/kis-domestic-trading/api/analyze-task/${taskId}`);
                const data = await response.json();

                const progressBar = document.getElementById(`${type}-progress-bar`);
                const status = document.getElementById(`${type}-status`);

                if (data.state === 'PENDING') return; // Simple pending check

                if (data.state === 'PROGRESS' && data.progress) {
                    const percentage = data.progress.percentage || 0;
                    progressBar.style.width = percentage + '%';
                    progressBar.textContent = percentage + '%';
                    status.textContent = data.progress.status || '진행 중...';
                } else if (data.state === 'SUCCESS') {
                    clearInterval(intervalId);
                    if (type === 'buy') buyTaskId = null;
                    if (type === 'sell') sellTaskId = null;
                    localStorage.removeItem(storageKey);

                    progressBar.style.width = '100%';
                    progressBar.textContent = '100%';
                    status.textContent = '완료!';
                    showAlert('✅ 작업 완료', 'success');

                    setTimeout(() => {
                        document.getElementById(`${type}-btn`).disabled = false;
                        document.getElementById(`${type}-progress`).style.display = 'none';
                        loadMyStocks();
                    }, 2000);
                } else if (data.state === 'FAILURE') {
                    clearInterval(intervalId);
                    if (type === 'buy') buyTaskId = null;
                    if (type === 'sell') sellTaskId = null;
                    localStorage.removeItem(storageKey);
                    showAlert('❌ 실패: ' + (data.result?.error || '오류'), 'danger');
                    document.getElementById(`${type}-btn`).disabled = false;
                    document.getElementById(`${type}-progress`).style.display = 'none';
                }
            } catch (e) { console.error(e); }
        }

        // 종목별 자동 실행
        async function runPerStockAutomation() {
            if (perStockAutomationRunning || stockAutomationTaskId) {
                showAlert('이미 종목별 자동 실행이 진행 중입니다.', 'warning');
                return;
            }
            if (!confirm('보유 중인 각 종목에 대해 분석 → 매수 → 매도 요청을 백그라운드에서 실행할까요?')) {
                return;
            }

            perStockAutomationRunning = true;
            const button = document.getElementById('per-stock-automation-btn');
            const progressWrapper = document.getElementById('per-stock-automation-progress');
            const progressBar = document.getElementById('per-stock-progress-bar');
            const statusEl = document.getElementById('per-stock-automation-status');
            const logEl = document.getElementById('per-stock-automation-log');

            progressWrapper.style.display = 'block';
            progressBar.style.width = '0%';
            progressBar.textContent = '0%';
            statusEl.textContent = '요청을 준비 중입니다...';
            logEl.innerHTML = '';

            button.disabled = true;
            button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 실행 중...';

            try {
                const response = await csrfFetch('/kis-domestic-trading/api/automation/per-stock', { method: 'POST' });
                const data = await response.json();

                if (data.success && data.task_id) {
                    stockAutomationTaskId = data.task_id;
                    localStorage.setItem(STORAGE_KEYS.STOCK_AUTOMATION, data.task_id);
                    statusEl.textContent = '종목별 자동 실행이 시작되었습니다.';
                    stockAutomationInterval = setInterval(checkStockAutomationProgress, 2000);
                    showAlert(data.message, 'success');
                } else {
                    showAlert('❌ 시작 실패', 'danger');
                    resetPerStockAutomationUI();
                }
            } catch (error) {
                showAlert('❌ 오류 발생: ' + error.message, 'danger');
                resetPerStockAutomationUI();
            }
        }

        async function checkStockAutomationProgress() {
            if (!stockAutomationTaskId) return;
            try {
                const response = await fetch(`/kis-domestic-trading/api/analyze-task/${stockAutomationTaskId}`);
                const data = await response.json();

                if (data.state === 'PENDING') return;

                if (data.state === 'PROGRESS') {
                    // Update progress UI
                    // Assuming progress structure similar to Upbit
                    return;
                }

                if (data.state === 'SUCCESS' || data.state === 'FAILURE') {
                    clearInterval(stockAutomationInterval);
                    stockAutomationTaskId = null;
                    localStorage.removeItem(STORAGE_KEYS.STOCK_AUTOMATION);
                    showAlert(data.state === 'SUCCESS' ? '완료되었습니다.' : '실패했습니다.', data.state === 'SUCCESS' ? 'success' : 'danger');
                    resetPerStockAutomationUI();
                    loadMyStocks();
                }
            } catch (e) { console.error(e); }
        }

        function resetPerStockAutomationUI() {
            perStockAutomationRunning = false;
            if (stockAutomationInterval) clearInterval(stockAutomationInterval);
            stockAutomationInterval = null;

            const button = document.getElementById('per-stock-automation-btn');
            button.disabled = false;
            button.innerHTML = '<i class="bi bi-collection-play"></i> 종목별 분석→매수→매도';
        }

        function attachStockActionHandlers() {
            // Individual stock action handlers
            document.querySelectorAll('.stock-analyze-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const analysisId = btn.dataset.id;
                    const symbol = btn.dataset.code;
                    const name = btn.dataset.name;

                    if (analysisId) {
                        openStockAnalysisDetail(analysisId, symbol, name);
                    } else {
                        // 분석 결과가 없으면 전체 분석 요청 유도 또는 개별 분석 실행 (추후 구현)
                        if (confirm(`${name} (${symbol})에 대한 분석 결과가 없습니다. 전체 분석을 실행하시겠습니까?`)) {
                            analyzeStocks();
                        }
                    }
                });
            });
            document.querySelectorAll('.stock-buy-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    alert('개별 매수 기능은 준비 중입니다.');
                });
            });
            document.querySelectorAll('.stock-sell-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    alert('개별 매도 기능은 준비 중입니다.');
                });
            });
        }

        // --- Helper Functions for Analysis Modal ---

        function formatLastAnalysisTime(isoString) {
            if (!isoString) return '-';
            const date = new Date(isoString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMins / 60);

            if (diffMins < 1) return '방금 전';
            if (diffMins < 60) return `${diffMins}분 전`;
            if (diffHours < 24) return `${diffHours}시간 전`;
            return date.toLocaleString();
        }

        function getDecisionBadge(decision) {
            const badges = {
                buy: '<span class="badge bg-success">매수</span>',
                sell: '<span class="badge bg-danger">매도</span>',
                hold: '<span class="badge bg-warning text-dark">보유</span>'
            };
            if (!decision) {
                return '<span class="badge bg-secondary">기록 없음</span>';
            }
            return badges[decision.toLowerCase()] || `<span class="badge bg-secondary">${escapeHtml(decision)}</span>`;
        }

        function formatPriceRange(min, max) {
            if (min === undefined || min === null || max === undefined || max === null) {
                return '-';
            }
            const minValue = Number(min);
            const maxValue = Number(max);
            if (Number.isNaN(minValue) || Number.isNaN(maxValue)) {
                return '-';
            }
            return `${minValue.toLocaleString()} ~ ${maxValue.toLocaleString()}`;
        }

        function escapeHtml(text) {
            if (!text) return '';
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        async function openStockAnalysisDetail(analysisId, symbol, name) {
            const modalElement = document.getElementById('stockAnalysisModal');
            const modalTitle = modalElement.querySelector('.modal-title');
            const modalBody = modalElement.querySelector('.modal-body');
            const linkElement = document.getElementById('stockAnalysisLink');
            const modal = bootstrap.Modal.getOrCreateInstance(modalElement);

            modalTitle.textContent = `${name} (${symbol}) 분석 상세`;
            modalBody.innerHTML = `
                <div class="text-center text-muted py-4">
                    <div class="spinner-border" role="status"></div>
                </div>
            `;

            // 차트 링크 (네이버 증권 등)
            if (symbol) {
                linkElement.href = `https://finance.naver.com/item/main.naver?code=${symbol}`;
                linkElement.classList.remove('d-none');
                linkElement.textContent = '네이버 증권 보기';
            } else {
                linkElement.classList.add('d-none');
            }

            modal.show();

            try {
                const response = await fetch(`/analysis-json/api/detail/${analysisId}`);
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const data = await response.json();

                if (data.error) {
                    modalBody.innerHTML = `<div class="alert alert-danger">${escapeHtml(data.error)}</div>`;
                    linkElement.classList.add('d-none');
                    return;
                }

                const reasonsHtml = (data.reasons && data.reasons.length > 0)
                    ? data.reasons.map(reason => `<li>${escapeHtml(reason)}</li>`).join('')
                    : '<li class="text-muted">근거 정보가 없습니다.</li>';

                const confidenceLabel = data.confidence !== null && data.confidence !== undefined
                    ? `${Number(data.confidence).toFixed(1)}%`
                    : '-';

                modalBody.innerHTML = `
                    <div class="mb-3">
                        <div class="d-flex flex-wrap align-items-center gap-2">
                            ${getDecisionBadge(data.decision)}
                            <span class="badge bg-light text-dark">신뢰도 ${confidenceLabel}</span>
                        </div>
                        <div class="small text-muted mt-1">${formatLastAnalysisTime(data.created_at)}</div>
                    </div>
                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header py-2"><small class="text-muted">적정 매수 범위</small></div>
                                <div class="card-body py-2">
                                    <strong>${formatPriceRange(data.appropriate_buy_range?.min, data.appropriate_buy_range?.max)}</strong>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header py-2"><small class="text-muted">적정 매도 범위</small></div>
                                <div class="card-body py-2">
                                    <strong>${formatPriceRange(data.appropriate_sell_range?.min, data.appropriate_sell_range?.max)}</strong>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header py-2"><small class="text-muted">희망 매수 범위</small></div>
                                <div class="card-body py-2">
                                    <strong>${formatPriceRange(data.buy_hope_range?.min, data.buy_hope_range?.max)}</strong>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header py-2"><small class="text-muted">목표 매도 범위</small></div>
                                <div class="card-body py-2">
                                    <strong>${formatPriceRange(data.sell_target_range?.min, data.sell_target_range?.max)}</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <h6>핵심 근거</h6>
                        <ol class="ps-3 mb-0">
                            ${reasonsHtml}
                        </ol>
                    </div>
                    ${data.detailed_text ? `
                        <div class="mb-0">
                            <h6>상세 분석</h6>
                            <div class="alert alert-light">
                                <pre class="mb-0" style="white-space: pre-wrap; font-family: inherit;">${escapeHtml(data.detailed_text)}</pre>
                            </div>
                        </div>
                    ` : ''}
                `;
            } catch (error) {
                console.error('분석 상세 로드 실패:', error);
                modalBody.innerHTML = '<div class="alert alert-danger">분석 상세 정보를 불러오는 중 오류가 발생했습니다.</div>';
                linkElement.classList.add('d-none');
            }
        }

        function showAlert(message, type) {
            const alertArea = document.getElementById('alert-area');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show`;
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            alertArea.prepend(alert);
            setTimeout(() => alert.remove(), 5000);
        }
    </script>
</body>

</html>