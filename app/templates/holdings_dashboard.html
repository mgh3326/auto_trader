<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>보유 자산 관리 - Auto Trader</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .stats-number {
            font-size: 1.5rem;
            font-weight: bold;
            margin: 0;
        }
        .stats-label {
            font-size: 0.8rem;
            opacity: 0.9;
            margin: 0;
        }
        .filter-section {
            background-color: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        .table-responsive {
            max-height: 700px;
            overflow-y: auto;
        }
        .badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }
        .bg-primary { background-color: #0d6efd !important; }
        .bg-info { background-color: #0dcaf0 !important; }
        .bg-success { background-color: #198754 !important; }
        .bg-secondary { background-color: #6c757d !important; }
        .updated-at {
            font-size: 0.8rem;
            color: #999;
        }
        .symbol-cell {
            font-family: monospace;
            font-weight: 600;
        }
        .quantity-cell {
            text-align: right;
            font-family: monospace;
        }
        .refresh-btn {
            position: relative;
        }
        .refresh-btn.loading .spinner {
            display: inline-block;
        }
        .refresh-btn .spinner {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- 페이지 헤더 -->
        <div class="row mb-3">
            <div class="col">
                <h1 class="h3">보유 자산 관리</h1>
                <p class="text-muted mb-2">KIS(국내/해외주식)와 Upbit(암호화폐) 보유 자산을 조회하고 관리합니다.</p>
            </div>
        </div>

        <!-- 통계 카드 섹션 -->
        <div class="row mb-3 statistics-section">
            <div class="col-lg-3 col-md-6">
                <div class="stats-card">
                    <p class="stats-number" id="total-count">-</p>
                    <p class="stats-label">전체 보유 종목</p>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stats-card">
                    <p class="stats-number" id="kr-stocks-count">-</p>
                    <p class="stats-label">국내 주식</p>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stats-card">
                    <p class="stats-number" id="us-stocks-count">-</p>
                    <p class="stats-label">미국 주식</p>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stats-card">
                    <p class="stats-number" id="crypto-count">-</p>
                    <p class="stats-label">암호화폐</p>
                </div>
            </div>
        </div>

        <!-- 필터 및 새로고침 섹션 -->
        <div class="filter-section">
            <div class="row g-3">
                <div class="col-md-4">
                    <label for="instrumentTypeFilter" class="form-label">상품 타입</label>
                    <select class="form-select" id="instrumentTypeFilter">
                        <option value="전체">전체</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="mockToggle" class="form-label">투자 모드 (KIS)</label>
                    <select class="form-select" id="mockToggle">
                        <option value="false">실전 투자</option>
                        <option value="true">모의 투자</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">&nbsp;</label>
                    <div class="d-flex gap-2">
                        <button class="btn btn-primary" onclick="loadHoldings()">
                            <i class="bi bi-search"></i> 조회
                        </button>
                        <button class="btn btn-success refresh-btn" id="refreshBtn" onclick="refreshHoldings()">
                            <span class="spinner spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                            <i class="bi bi-arrow-clockwise"></i> 갱신
                        </button>
                        <button class="btn btn-info refresh-btn" id="syncAnalysisBtn" onclick="syncAnalysis()">
                            <span class="spinner spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                            <i class="bi bi-arrow-repeat"></i> 분석 동기화
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 결과 테이블 -->
        <div class="card" id="resultsSection">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">보유 자산 목록</h5>
                <div>
                    <span class="badge bg-secondary me-2" id="totalCount">총 0건</span>
                    <span class="updated-at" id="lastUpdated">마지막 갱신: -</span>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>종목 코드</th>
                                <th>종목명</th>
                                <th>상품 타입</th>
                                <th>거래소</th>
                                <th style="text-align: right;">보유 수량</th>
                                <th style="text-align: right;">현재가</th>
                                <th style="text-align: right;">희망 매수가</th>
                                <th style="text-align: right;">목표 매도가</th>
                                <th style="text-align: right;">손절가</th>
                                <th>분석</th>
                                <th>업데이트</th>
                                <th>액션</th>
                            </tr>
                        </thead>
                        <tbody id="holdingsTableBody">
                            <!-- 결과가 여기에 동적으로 추가됩니다 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 로딩 스피너 -->
        <div class="text-center my-4" id="loadingSpinner" style="display: none;">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">로딩 중...</span>
            </div>
        </div>

        <!-- 에러 메시지 -->
        <div class="alert alert-danger mt-3" id="errorMessage" style="display: none;">
            데이터를 불러오는 중 오류가 발생했습니다.
        </div>

        <!-- 성공 메시지 -->
        <div class="alert alert-success mt-3" id="successMessage" style="display: none;">
            보유 자산이 성공적으로 갱신되었습니다.
        </div>
    </div>

    <!-- 분석 상세 모달 -->
    <div class="modal fade" id="analysisModal" tabindex="-1" aria-labelledby="analysisModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="analysisModalLabel">분석 상세 정보</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="analysisModalBody">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">로딩 중...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 상품 타입별 배지 색상 함수
        function getInstrumentTypeBadge(type) {
            const badges = {
                'equity_kr': '<span class="badge bg-primary">한국 주식</span>',
                'equity_us': '<span class="badge bg-info">미국 주식</span>',
                'crypto': '<span class="badge bg-success">암호화폐</span>'
            };
            return badges[type] || `<span class="badge bg-secondary">${type}</span>`;
        }

        // 날짜 포맷팅 함수
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            const dateStr = date.toLocaleDateString('ko-KR').replace(/\./g, '.').replace(/\s/g, '');
            const timeStr = date.toLocaleTimeString('ko-KR', {hour: '2-digit', minute: '2-digit'});
            return `${dateStr} ${timeStr}`;
        }

        // 숫자 포맷팅 함수
        function formatNumber(num) {
            if (num === null || num === undefined) return '-';
            return num.toLocaleString('ko-KR', {maximumFractionDigits: 8});
        }

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', function() {
            loadFilters();
            loadStatistics();
            loadHoldings();
        });

        // 필터 옵션 로드
        async function loadFilters() {
            try {
                const response = await fetch('/holdings/api/filters');
                if (!response.ok) throw new Error('Network response was not ok');

                const result = await response.json();
                const data = result.data;

                // 상품 타입 옵션 로드
                const instrumentTypeSelect = document.getElementById('instrumentTypeFilter');

                // 한글 이름 매핑
                const typeNames = {
                    'equity_kr': '한국 주식',
                    'equity_us': '미국 주식',
                    'crypto': '암호화폐'
                };

                data.instrument_types.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = typeNames[type] || type;
                    instrumentTypeSelect.appendChild(option);
                });
            } catch (error) {
                console.error('필터 옵션 로드 실패:', error);
            }
        }

        // 통계 로드
        async function loadStatistics() {
            try {
                const response = await fetch('/holdings/api/statistics');
                if (!response.ok) throw new Error('Network response was not ok');

                const result = await response.json();
                const data = result.data;

                document.getElementById('total-count').textContent = data.total_count || 0;
                document.getElementById('kr-stocks-count').textContent = data.kr_stocks_count || 0;
                document.getElementById('us-stocks-count').textContent = data.us_stocks_count || 0;
                document.getElementById('crypto-count').textContent = data.crypto_count || 0;

                if (data.last_updated) {
                    document.getElementById('lastUpdated').textContent = `마지막 갱신: ${formatDate(data.last_updated)}`;
                }
            } catch (error) {
                console.error('통계 로드 실패:', error);
            }
        }

        // 보유 자산 조회
        async function loadHoldings() {
            // 로딩 스피너 표시
            document.getElementById('loadingSpinner').style.display = 'block';
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';

            // 필터 값 가져오기
            const instrumentType = document.getElementById('instrumentTypeFilter').value;

            // URL 파라미터 구성
            const params = new URLSearchParams();
            if (instrumentType && instrumentType !== '전체') {
                params.append('instrument_type', instrumentType);
            }

            try {
                const response = await fetch(`/holdings/api/list?${params}`);
                if (!response.ok) throw new Error('Network response was not ok');

                const result = await response.json();

                // 결과 테이블 업데이트
                updateHoldingsTable(result.data);

                // 총 개수 업데이트
                document.getElementById('totalCount').textContent = `총 ${result.count}건`;

            } catch (error) {
                console.error('보유 자산 조회 실패:', error);
                document.getElementById('errorMessage').style.display = 'block';
                document.getElementById('errorMessage').textContent = `조회 실패: ${error.message}`;
            } finally {
                document.getElementById('loadingSpinner').style.display = 'none';
            }
        }

        // 보유 자산 테이블 업데이트
        function updateHoldingsTable(holdings) {
            const tbody = document.getElementById('holdingsTableBody');
            tbody.innerHTML = '';

            holdings.forEach(holding => {
                const row = document.createElement('tr');

                // 분석 데이터 여부 표시
                const analysisStatus = holding.has_analysis
                    ? `<span class="badge bg-success" title="분석일: ${formatDate(holding.analysis_date)}">✓</span>`
                    : `<span class="badge bg-secondary">-</span>`;

                // 분석 보기 버튼
                const analysisBtn = holding.has_analysis
                    ? `<button class="btn btn-sm btn-outline-info" onclick="showAnalysis('${holding.symbol}')"><i class="bi bi-file-text"></i> 보기</button>`
                    : `<button class="btn btn-sm btn-outline-secondary" disabled>분석 없음</button>`;

                row.innerHTML = `
                    <td class="symbol-cell">${holding.symbol}</td>
                    <td>${holding.name}</td>
                    <td>${getInstrumentTypeBadge(holding.instrument_type)}</td>
                    <td><small class="text-muted">${holding.exchange}</small></td>
                    <td class="quantity-cell">${formatNumber(holding.quantity)}</td>
                    <td class="quantity-cell">${formatNumber(holding.current_price)}</td>
                    <td class="quantity-cell">${formatNumber(holding.desired_buy_px)}</td>
                    <td class="quantity-cell">${formatNumber(holding.target_sell_px)}</td>
                    <td class="quantity-cell">${formatNumber(holding.stop_loss_px)}</td>
                    <td>${analysisStatus}</td>
                    <td><small class="updated-at">${formatDate(holding.updated_at)}</small></td>
                    <td>${analysisBtn}</td>
                `;

                tbody.appendChild(row);
            });

            if (holdings.length === 0) {
                tbody.innerHTML = '<tr><td colspan="12" class="text-center text-muted">보유 자산이 없습니다.</td></tr>';
            }
        }

        // 보유 자산 갱신
        async function refreshHoldings() {
            const btn = document.getElementById('refreshBtn');
            const isMock = document.getElementById('mockToggle').value === 'true';

            // 버튼 비활성화 및 로딩 표시
            btn.disabled = true;
            btn.classList.add('loading');

            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';

            try {
                const response = await fetch(`/holdings/api/refresh?is_mock=${isMock}`, {
                    method: 'POST'
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || '갱신 실패');
                }

                const result = await response.json();

                // 성공 메시지 표시
                document.getElementById('successMessage').style.display = 'block';

                // 에러가 있으면 표시
                if (result.data.errors && result.data.errors.length > 0) {
                    const errorMsg = document.getElementById('errorMessage');
                    errorMsg.innerHTML = '<strong>일부 오류 발생:</strong><br>' + result.data.errors.join('<br>');
                    errorMsg.style.display = 'block';
                }

                // 통계 및 목록 새로고침
                await loadStatistics();
                await loadHoldings();

            } catch (error) {
                console.error('갱신 실패:', error);
                document.getElementById('errorMessage').style.display = 'block';
                document.getElementById('errorMessage').textContent = `갱신 실패: ${error.message}`;
            } finally {
                // 버튼 복원
                btn.disabled = false;
                btn.classList.remove('loading');
            }
        }

        // 분석 동기화
        async function syncAnalysis() {
            const btn = document.getElementById('syncAnalysisBtn');

            // 버튼 비활성화 및 로딩 표시
            btn.disabled = true;
            btn.classList.add('loading');

            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';

            try {
                const response = await fetch('/holdings/api/sync-analysis', {
                    method: 'POST'
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || '동기화 실패');
                }

                const result = await response.json();

                // 성공 메시지 표시
                const successMsg = document.getElementById('successMessage');
                successMsg.innerHTML = `<strong>분석 동기화 완료</strong><br>업데이트: ${result.data.updated}건, 스킵: ${result.data.skipped}건`;
                successMsg.style.display = 'block';

                // 에러가 있으면 표시
                if (result.data.errors && result.data.errors.length > 0) {
                    const errorMsg = document.getElementById('errorMessage');
                    errorMsg.innerHTML = '<strong>일부 오류 발생:</strong><br>' + result.data.errors.join('<br>');
                    errorMsg.style.display = 'block';
                }

                // 목록 새로고침
                await loadHoldings();

            } catch (error) {
                console.error('동기화 실패:', error);
                document.getElementById('errorMessage').style.display = 'block';
                document.getElementById('errorMessage').textContent = `동기화 실패: ${error.message}`;
            } finally {
                // 버튼 복원
                btn.disabled = false;
                btn.classList.remove('loading');
            }
        }

        // 분석 상세 정보 표시
        async function showAnalysis(symbol) {
            const modal = new bootstrap.Modal(document.getElementById('analysisModal'));
            const modalBody = document.getElementById('analysisModalBody');
            const modalTitle = document.getElementById('analysisModalLabel');

            // 로딩 표시
            modalBody.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"></div></div>';
            modalTitle.textContent = `${symbol} 분석 정보`;
            modal.show();

            try {
                // StockInfo ID 조회 후 최신 분석 조회
                const response = await fetch(`/stock-latest/api/stock-symbol/${symbol}/latest`);

                if (!response.ok) {
                    throw new Error('분석 정보를 찾을 수 없습니다.');
                }

                const data = await response.json();

                // 분석 상세 HTML 생성
                const analysisHtml = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>기본 정보</h6>
                            <table class="table table-sm">
                                <tr><td>종목</td><td><strong>${data.name} (${data.symbol})</strong></td></tr>
                                <tr><td>상품타입</td><td>${getInstrumentTypeBadge(data.instrument_type)}</td></tr>
                                <tr><td>모델명</td><td><code>${data.model_name}</code></td></tr>
                                <tr><td>분석일시</td><td>${formatDate(data.created_at)}</td></tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6>투자 결정</h6>
                            <div class="mb-3">
                                ${getDecisionBadge(data.decision)}
                                <div class="mt-2">
                                    <strong>신뢰도:</strong> ${data.confidence}%
                                    <div class="progress mt-1" style="height: 10px;">
                                        <div class="progress-bar" role="progressbar" style="width: ${data.confidence}%"></div>
                                    </div>
                                </div>
                            </div>

                            <h6>분석 근거</h6>
                            <ol class="mb-3">
                                ${data.reasons && data.reasons.length > 0
                                    ? data.reasons.map(r => `<li>${r}</li>`).join('')
                                    : '<li class="text-muted">근거 정보가 없습니다.</li>'}
                            </ol>
                        </div>
                    </div>

                    <hr>

                    <div class="row">
                        <div class="col-12">
                            <h6>가격 분석</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card mb-2">
                                        <div class="card-header py-2"><small class="text-muted">적절한 매수 범위</small></div>
                                        <div class="card-body py-2">
                                            <strong>${formatNumber(data.appropriate_buy_range.min)} ~ ${formatNumber(data.appropriate_buy_range.max)}</strong>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card mb-2">
                                        <div class="card-header py-2"><small class="text-muted">적절한 매도 범위</small></div>
                                        <div class="card-body py-2">
                                            <strong>${formatNumber(data.appropriate_sell_range.min)} ~ ${formatNumber(data.appropriate_sell_range.max)}</strong>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card mb-2">
                                        <div class="card-header py-2"><small class="text-muted">매수 희망 범위</small></div>
                                        <div class="card-body py-2">
                                            <strong>${formatNumber(data.buy_hope_range.min)} ~ ${formatNumber(data.buy_hope_range.max)}</strong>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card mb-2">
                                        <div class="card-header py-2"><small class="text-muted">매도 목표 범위</small></div>
                                        <div class="card-body py-2">
                                            <strong>${formatNumber(data.sell_target_range.min)} ~ ${formatNumber(data.sell_target_range.max)}</strong>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    ${data.detailed_text ? `
                    <hr>
                    <div class="row">
                        <div class="col-12">
                            <h6>상세 분석 내용</h6>
                            <div class="alert alert-light">
                                <pre style="white-space: pre-wrap; font-family: inherit; margin: 0;">${data.detailed_text}</pre>
                            </div>
                        </div>
                    </div>
                    ` : ''}
                `;

                modalBody.innerHTML = analysisHtml;

            } catch (error) {
                console.error('분석 정보 로드 실패:', error);
                modalBody.innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
            }
        }

        // 투자 결정 배지
        function getDecisionBadge(decision) {
            const badges = {
                'buy': '<span class="badge bg-success" style="font-size: 1rem;">매수</span>',
                'sell': '<span class="badge bg-danger" style="font-size: 1rem;">매도</span>',
                'hold': '<span class="badge bg-warning" style="font-size: 1rem;">보유</span>'
            };
            return badges[decision] || `<span class="badge bg-secondary">${decision}</span>`;
        }
    </script>
</body>
</html>
