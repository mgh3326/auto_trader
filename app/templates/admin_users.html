{% extends "base.html" %}

{% block title %}ì‚¬ìš©ì ê´€ë¦¬ - Auto Trader{% endblock %}

{% block styles %}
.admin-container {
    max-width: 1200px;
    width: 100%;
    background: white;
    padding: 2rem;
    border-radius: 20px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
}

.admin-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #e0e0e0;
}

.admin-header h1 {
    color: #333;
    margin: 0;
}

.admin-header .stats {
    display: flex;
    gap: 2rem;
}

.stat-item {
    text-align: center;
}

.stat-value {
    font-size: 2rem;
    font-weight: bold;
    color: #667eea;
}

.stat-label {
    color: #999;
    font-size: 0.875rem;
}

.users-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
}

.users-table th {
    background: #f5f5f5;
    padding: 1rem;
    text-align: left;
    font-weight: 600;
    color: #333;
    border-bottom: 2px solid #e0e0e0;
}

.users-table td {
    padding: 1rem;
    border-bottom: 1px solid #f0f0f0;
}

.users-table tr:hover {
    background: #fafafa;
}

.badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.875rem;
    font-weight: 600;
}

.badge-admin {
    background: #dc3545;
    color: white;
}

.badge-trader {
    background: #28a745;
    color: white;
}

.badge-viewer {
    background: #6c757d;
    color: white;
}

.badge-active {
    background: #e8f5e9;
    color: #2e7d32;
}

.badge-inactive {
    background: #ffebee;
    color: #c62828;
}

.role-select {
    padding: 0.5rem;
    border: 1px solid #ddd;
    border-radius: 6px;
    background: white;
    cursor: pointer;
    font-size: 0.875rem;
}

.role-select:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.btn-toggle {
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.875rem;
    transition: all 0.3s;
}

.btn-toggle.active {
    background: #28a745;
    color: white;
}

.btn-toggle.inactive {
    background: #dc3545;
    color: white;
}

.btn-toggle:hover {
    opacity: 0.8;
}

.btn-toggle:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.message {
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 1rem;
}

.message-success {
    background: #e8f5e9;
    color: #2e7d32;
}

.message-error {
    background: #ffebee;
    color: #c62828;
}

.loading {
    display: none;
    text-align: center;
    padding: 2rem;
    color: #999;
}

.loading.show {
    display: block;
}
{% endblock %}

{% block content %}
<div class="admin-container">
    <div class="admin-header">
        <h1>ğŸ‘¥ ì‚¬ìš©ì ê´€ë¦¬</h1>
        <div class="stats">
            <div class="stat-item">
                <div class="stat-value" id="total-users">{{ users|length }}</div>
                <div class="stat-label">ì´ ì‚¬ìš©ì</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="active-users">{{ users|selectattr('is_active')|list|length }}</div>
                <div class="stat-label">í™œì„± ì‚¬ìš©ì</div>
            </div>
        </div>
    </div>

    <div id="message-container"></div>

    <div class="loading" id="loading">
        <p>ì²˜ë¦¬ ì¤‘...</p>
    </div>

    <table class="users-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>ì‚¬ìš©ìëª…</th>
                <th>ì´ë©”ì¼</th>
                <th>ê¶Œí•œ</th>
                <th>ìƒíƒœ</th>
                <th>ê°€ì…ì¼</th>
                <th>ê´€ë¦¬</th>
            </tr>
        </thead>
        <tbody id="users-tbody">
            {% for u in users %}
            <tr data-user-id="{{ u.id }}">
                <td>{{ u.id }}</td>
                <td>{{ u.username }}</td>
                <td>{{ u.email }}</td>
                <td>
                    <select class="role-select" data-user-id="{{ u.id }}"
                            {% if u.id == user.id %}disabled{% endif %}>
                        <option value="viewer" {% if u.role.value == 'viewer' %}selected{% endif %}>Viewer</option>
                        <option value="trader" {% if u.role.value == 'trader' %}selected{% endif %}>Trader</option>
                        <option value="admin" {% if u.role.value == 'admin' %}selected{% endif %}>Admin</option>
                    </select>
                </td>
                <td>
                    <span class="badge {% if u.is_active %}badge-active{% else %}badge-inactive{% endif %}">
                        {% if u.is_active %}í™œì„±{% else %}ë¹„í™œì„±{% endif %}
                    </span>
                </td>
                <td>{{ u.created_at[:10] if u.created_at else 'N/A' }}</td>
                <td>
                    <button class="btn-toggle {% if u.is_active %}active{% else %}inactive{% endif %}"
                            data-user-id="{{ u.id }}"
                            {% if u.id == user.id %}disabled{% endif %}>
                        {% if u.is_active %}ë¹„í™œì„±í™”{% else %}í™œì„±í™”{% endif %}
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}

{% block scripts %}
<script>
// Role change handler
document.querySelectorAll('.role-select').forEach(select => {
    select.addEventListener('change', async (e) => {
        const userId = e.target.dataset.userId;
        const newRole = e.target.value;

        if (!confirm(`ì‚¬ìš©ì ê¶Œí•œì„ ${newRole}(ìœ¼)ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
            e.target.value = e.target.dataset.originalValue || 'viewer';
            return;
        }

        showLoading();

        try {
            const response = await fetch(`/admin/users/${userId}/role`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ role: newRole })
            });

            const data = await response.json();

            if (response.ok) {
                showMessage('ê¶Œí•œì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                e.target.dataset.originalValue = newRole;
            } else {
                showMessage(data.detail || 'ê¶Œí•œ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                e.target.value = e.target.dataset.originalValue || 'viewer';
            }
        } catch (error) {
            showMessage('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            e.target.value = e.target.dataset.originalValue || 'viewer';
        } finally {
            hideLoading();
        }
    });

    // Store original value
    select.dataset.originalValue = select.value;
});

// Active/Inactive toggle handler
document.querySelectorAll('.btn-toggle').forEach(button => {
    button.addEventListener('click', async (e) => {
        const userId = e.target.dataset.userId;
        const isActive = e.target.classList.contains('active');
        const action = isActive ? 'ë¹„í™œì„±í™”' : 'í™œì„±í™”';

        if (!confirm(`ì‚¬ìš©ìë¥¼ ${action}í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
            return;
        }

        showLoading();

        try {
            const response = await fetch(`/admin/users/${userId}/toggle`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                }
            });

            const data = await response.json();

            if (response.ok) {
                showMessage(`ì‚¬ìš©ìê°€ ${action}ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');

                // Update UI
                const row = button.closest('tr');
                const badge = row.querySelector('.badge');

                if (data.is_active) {
                    button.classList.remove('inactive');
                    button.classList.add('active');
                    button.textContent = 'ë¹„í™œì„±í™”';
                    badge.classList.remove('badge-inactive');
                    badge.classList.add('badge-active');
                    badge.textContent = 'í™œì„±';
                } else {
                    button.classList.remove('active');
                    button.classList.add('inactive');
                    button.textContent = 'í™œì„±í™”';
                    badge.classList.remove('badge-active');
                    badge.classList.add('badge-inactive');
                    badge.textContent = 'ë¹„í™œì„±';
                }

                // Update active users count
                updateStats();
            } else {
                showMessage(data.detail || 'ìƒíƒœ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        } catch (error) {
            showMessage('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        } finally {
            hideLoading();
        }
    });
});

function showMessage(text, type) {
    const container = document.getElementById('message-container');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message message-${type}`;
    messageDiv.textContent = text;
    container.appendChild(messageDiv);

    setTimeout(() => {
        messageDiv.remove();
    }, 3000);
}

function showLoading() {
    document.getElementById('loading').classList.add('show');
}

function hideLoading() {
    document.getElementById('loading').classList.remove('show');
}

function updateStats() {
    const rows = document.querySelectorAll('#users-tbody tr');
    let activeCount = 0;

    rows.forEach(row => {
        const badge = row.querySelector('.badge');
        if (badge.classList.contains('badge-active')) {
            activeCount++;
        }
    });

    document.getElementById('active-users').textContent = activeCount;
}
</script>
{% endblock %}
